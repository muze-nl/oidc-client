{
  "version": 3,
  "sources": ["../node_modules/@muze-nl/metro/src/metro.mjs", "../node_modules/@muze-nl/metro/src/mw/json.mjs", "../node_modules/@muze-nl/metro/src/mw/thrower.mjs", "../node_modules/@muze-nl/metro/src/everything.mjs", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.mjs", "../node_modules/@muze-nl/assert/src/assert.mjs", "../node_modules/@muze-nl/metro-oauth2/src/tokenstore.mjs", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.mockserver.mjs", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.discovery.mjs", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.popup.mjs", "../node_modules/@muze-nl/metro-oauth2/src/keysstore.mjs", "../node_modules/dpop/build/index.js", "../node_modules/@muze-nl/metro-oauth2/src/oauth2.dpop.mjs", "../node_modules/@muze-nl/metro-oauth2/src/browser.mjs", "../node_modules/@muze-nl/metro-oidc/src/oidc.util.mjs", "../node_modules/@muze-nl/metro-oidc/src/oidc.discovery.mjs", "../node_modules/@muze-nl/metro-oidc/src/oidc.register.mjs", "../node_modules/@muze-nl/metro-oidc/src/oidc.store.mjs", "../node_modules/@muze-nl/metro-oidc/src/oidcmw.mjs", "../node_modules/@muze-nl/metro-oidc/src/browser.mjs", "../src/client.mjs"],
  "sourcesContent": ["/**\n * base URL used to link to more information about an error message\n */\nconst metroURL = 'https://metro.muze.nl/details/'\n\n/**\n * Symbols:\n * - isProxy: used to test if an object is a metro Proxy to another object\n * - source: used to return the actual source (target) of a metro Proxy\n */\nif (!Symbol.metroProxy) {\n\tSymbol.metroProxy = Symbol('isProxy')\n}\nif (!Symbol.metroSource) {\n\tSymbol.metroSource = Symbol('source')\n}\n\n/**\n * Metro HTTP Client with middleware support\n * @method get\n * @method post\n * @method put\n * @method delete\n * @method patch\n * @method head\n * @method options\n * @method query\n * @method fetch\n */\nclass Client\n{\n\t#options = {\n\t\turl: typeof window != 'undefined' ? window.location : 'https://localhost'\n\t}\n\t#verbs = ['get','post','put','delete','patch','head','options','query']\n\n\tstatic tracers = {}\n\n\t/**\n\t * @typedef {Object} ClientOptions\n\t * @property {Array} middlewares - list of middleware functions\n\t * @property {string|URL} url - default url of the client\n\t * @property {[string]} verbs - a list of verb methods to expose, e.g. ['get','post']\n\t * \n\t * Constructs a new metro client. Can have any number of params.\n\t * @params {ClientOptions|URL|Function|Client}\n\t * @returns {Client} - A metro client object with given or default verb methods\n\t */\n\tconstructor(...options)\n\t{\n\t\tfor (let option of options) {\n\t\t\tif (typeof option == 'string' || option instanceof String) {\n\t\t\t\tthis.#options.url = ''+option\n\t\t\t} else if (option instanceof Client) {\n\t\t\t\tObject.assign(this.#options, option.#options)\n\t\t\t} else if (option instanceof Function) {\n\t\t\t\tthis.#addMiddlewares([option])\n\t\t\t} else if (option && typeof option == 'object') {\n\t\t\t\tfor (let param in option) {\n\t\t\t\t\tif (param == 'middlewares') {\n\t\t\t\t\t\tthis.#addMiddlewares(option[param])\n\t\t\t\t\t} else if (typeof option[param] == 'function') {\n\t\t\t\t\t\tthis.#options[param] = option[param](this.#options[param], this.#options)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.#options[param] = option[param]\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (this.#options.verbs) {\n\t\t\tthis.#verbs = this.#options.verbs\n\t\t\tdelete this.#options.verbs\n\t\t}\n\n\t\tfor (const verb of this.#verbs) {\n\t\t\tthis[verb] = async function(...options) {\n\t\t\t\treturn this.fetch(request(\n\t\t\t\t\tthis.#options,\n\t\t\t\t\t...options,\n\t\t\t\t\t{method: verb.toUpperCase()}\n\t\t\t\t))\n\t\t\t}\n\t\t}\n\t\tObject.freeze(this)\n\t}\n\n\t#addMiddlewares(middlewares)\n\t{\n\t\tif (typeof middlewares == 'function') {\n\t\t\tmiddlewares = [ middlewares ]\n\t\t}\n\t\tlet index = middlewares.findIndex(m => typeof m != 'function')\n\t\tif (index>=0) {\n\t\t\tthrow metroError('metro.client: middlewares must be a function or an array of functions '\n\t\t\t\t+metroURL+'client/invalid-middlewares/', middlewares[index])\n\t\t}\n\t\tif (!Array.isArray(this.#options.middlewares)) {\n\t\t\tthis.#options.middlewares = []\n\t\t}\n\t\tthis.#options.middlewares = this.#options.middlewares.concat(middlewares)\n\t}\n\n\t/**\n\t * Mimics the standard browser fetch method, but uses any middleware installed through\n\t * the constructor.\n\t * @param {Request|string|Object} - Required. The URL or Request object, accepts all types that are accepted by metro.request\n\t * @param {Object} - Optional. Any object that is accepted by metro.request\n\t * @return {Promise<Response|*>} - The metro.response to this request, or any other result as changed by any included middleware.\n\t */\n\tfetch(req, options)\n\t{\n\t\treq = request(req, options)\n\t\tif (!req.url) {\n\t\t\tthrow metroError('metro.client.'+req.method.toLowerCase()+': Missing url parameter '+metroURL+'client/fetch-missing-url/', req)\n\t\t}\n\t\tif (!options) {\n\t\t\toptions = {}\n\t\t}\n\t\tif (!(typeof options === 'object') \n\t\t\t|| options instanceof String) \n\t\t{\n\t\t\tthrow metroError('metro.client.fetch: Invalid options parameter '+metroURL+'client/fetch-invalid-options/', options)\n\t\t}\n\n\t\tconst metrofetch = async function browserFetch(req)\n\t\t{\n\t\t\tif (req[Symbol.metroProxy]) {\n\t\t\t\treq = req[Symbol.metroSource]\n\t\t\t}\n\t\t\tconst res = await fetch(req)\n\t\t\treturn response(res)\n\t\t}\n\t\t\n\t\tlet middlewares = [metrofetch].concat(this.#options?.middlewares?.slice() || [])\n\t\toptions = Object.assign({}, this.#options, options)\n\t\t//@TODO: do this once in constructor?\n\t\tlet next\n\t\tfor (let middleware of middlewares) {\n\t\t\tnext = (function(next, middleware) {\n\t\t\t\treturn async function(req) {\n\t\t\t\t\tlet res\n\t\t\t\t\tlet tracers = Object.values(Client.tracers)\n\t\t\t\t\tfor(let tracer of tracers) {\n\t\t\t\t\t\tif (tracer.request) {\n\t\t\t\t\t\t\ttracer.request.call(tracer, req, middleware)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tres = await middleware(req, next)\n\t\t\t\t\tfor(let tracer of tracers) {\n\t\t\t\t\t\tif (tracer.response) {\n\t\t\t\t\t\t\ttracer.response.call(tracer, res, middleware)\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn res\n\t\t\t\t}\t\t\t\t\t\t\t\t\n\t\t\t})(next, middleware)\n\t\t}\n\t\treturn next(req)\n\t}\n\n\twith(...options) {\n\t\treturn new Client(this, ...options)\n\t}\n}\n\n/**\n * Returns a new metro Client object.\n * @param {...ClientOptions|string|URL}\n * @return Client\n */\nexport function client(...options)\n{\n\treturn new Client(...options)\n}\n\nfunction appendHeaders(r, headers)\n{\n\tif (!Array.isArray(headers)) {\n\t\theaders = [headers]\n\t}\n\theaders.forEach((header) => {\n\t\tif (typeof header == 'function') {\n\t\t\tlet result = header(r.headers, r)\n\t\t\tif (result) {\n\t\t\t\tif (!Array.isArray(result)) {\n\t\t\t\t\tresult = [result]\n\t\t\t\t}\n\t\t\t\theaders = headers.concat(result)\n\t\t\t}\n\t\t}\n\t})\n\theaders.forEach((header) => {\n\t\tObject.entries(header).forEach(([name,value]) => {\t\t\t\n\t\t\tr.headers.append(name, value)\n\t\t})\n\t})\n}\n\nfunction getRequestParams(req, current)\n{\n\tlet params = current || {}\n\tif (!params.url && current.url) {\n\t\tparams.url = current.url\n\t}\n\t// function to fetch all relevant properties of a Request\n\tfor(let prop of ['method','headers','body','mode','credentials','cache','redirect',\n\t\t'referrer','referrerPolicy','integrity','keepalive','signal',\n\t\t'priority','url']) {\n\t\tlet value = req[prop]\n\t\tif (typeof value=='undefined' || value == null) {\n\t\t\tcontinue\n\t\t}\n\t\tif (value?.[Symbol.metroProxy]) {\n\t\t\tvalue = value[Symbol.metroSource]\n\t\t}\n\t\tif (typeof value == 'function') {\n\t\t\tparams[prop] = value(params[prop], params)\n\t\t} else {\n\t\t\tif (prop == 'url') {\n\t\t\t\tparams.url = url(params.url, value)\n\t\t\t} else if (prop == 'headers') {\n\t\t\t\tparams.headers = new Headers(current.headers)\n\t\t\t\tif (!(value instanceof Headers)) {\n\t\t\t\t\tvalue = new Headers(req.headers)\n\t\t\t\t}\n\t\t\t\tfor (let [key, val] of value.entries()) {\n\t\t\t\t\tparams.headers.set(key, val)\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tparams[prop] = value\n\t\t\t}\n\t\t}\n\t}\n\tif (req instanceof Request && req.data) {\n\t\t// Request.body is always transformed into ReadableStreem\n\t\t// metro.request.data is the original body passed to Request()\n\t\tparams.body = req.data\n\t}\n\treturn params\n}\n\n/**\n * @typedef {Request} MetroRequest\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<RequestOptions|Request|string|URL|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * \n * Returns a new metro Request object\n * @param {<RequestOptions|Request|string|URL|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * @return {MetroRequest} - a new metro Request object\n */\nexport function request(...options)\n{\n\t// the standard Request constructor is a minefield\n\t// so first gather all the options together into a single\n\t// javascript object, then set it in one go\n\tlet requestParams = {\n\t\turl: typeof window != 'undefined' ? window.location : 'https://localhost/',\n\t\tduplex: 'half' // required when setting body to ReadableStream, just set it here by default already\n\t}\n\tfor (let option of options) {\n\t\tif (typeof option == 'string'\n\t\t\t|| option instanceof URL\n\t\t\t|| option instanceof URLSearchParams\n\t\t) {\n\t\t\trequestParams.url = url(requestParams.url, option)\n\t\t} else if (option && (\n\t\t\toption instanceof FormData\n\t\t\t|| option instanceof ReadableStream\n\t\t\t|| option instanceof Blob\n\t\t\t|| option instanceof ArrayBuffer\n\t\t\t|| option instanceof DataView\n\t\t)) {\n\t\t\trequestParams.body = option\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tObject.assign(requestParams, getRequestParams(option, requestParams))\n\t\t}\n\t}\n\tlet r = new Request(requestParams.url, requestParams)\n\tlet data = requestParams.body\n\tif (data) {\n\t\tif (typeof data == 'object'\n\t\t\t&& !(data instanceof String)\n\t\t\t&& !(data instanceof ReadableStream)\n\t\t\t&& !(data instanceof Blob)\n\t\t\t&& !(data instanceof ArrayBuffer)\n\t\t\t&& !(data instanceof DataView)\n\t\t\t&& !(data instanceof FormData)\n\t\t\t&& !(data instanceof URLSearchParams)\n\t\t\t&& (typeof TypedArray=='undefined' || !(data instanceof TypedArray))\n\t\t) {\n\t\t\t// if we are here, body is set with an object of a type\n\t\t\t// not natively understood by Request, coerce it to a string\n\t\t\t// using toString({headers}) instead of just toString()\n\t\t\tif (typeof data.toString == 'function') {\n\t\t\t\trequestParams.body = data.toString({headers:r.headers})\n\t\t\t\tr = new Request(requestParams.url, requestParams)\n\t\t\t}\n\t\t}\n\t}\n\tObject.freeze(r)\n\treturn new Proxy(r, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\tif (data) { // data is kept in a seperate value, if it set earlier\n\t\t\t\t\t\t\toptions.unshift({ body: data }) // unshifted so it can be overridden by options\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn request(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'data':\n\t\t\t\t\treturn data\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\tif (prop === 'clone') {\n\t\t\t\t\t// TODO: set req.data as the body of the clone\n\t\t\t\t}\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\nfunction getResponseParams(res, current)\n{\n\t// function to fetch all relevant properties of a Response\n\tlet params = current || {}\n\tif (!params.url && current.url) {\n\t\tparams.url = current.url\n\t}\n\tfor(let prop of ['status','statusText','headers','body','url','type','redirected']) {\n\t\tlet value = res[prop]\n\t\tif (typeof value == 'undefined' || value == null) {\n\t\t\tcontinue\n\t\t}\n\t\tif (value?.[Symbol.metroProxy]) {\n\t\t\tvalue = value[Symbol.metroSource]\n\t\t}\n\t\tif (typeof value == 'function') {\n\t\t\tparams[prop] = value(params[prop], params)\n\t\t} else {\n\t\t\tif (prop == 'url') {\n\t\t\t\tparams.url = new URL(value, params.url || 'https://localhost/')\n\t\t\t} else {\n\t\t\t\tparams[prop] = value\n\t\t\t}\n\t\t}\n\t}\n\tif (res instanceof Response && res.data) {\n\t\t// Response.body is always transformed into ReadableStreem FIXME: check this\n\t\t// metro.response.data is the original body passed to Response()\n\t\tparams.body = res.data\n\t}\n\treturn params\n}\n\n/**\n * @typedef {Response} MetroResponse\n * @property {Symbol(source)} - returns the target Response of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroResponse, with the given options added\n * @param {<ResponseOptions|Response|string|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - respomse options, handled in order\n * \n * Returns a new metro Response object\n * @param {<ResponseOptions|Response|string|URLSearchParams|FormData|ReadableStream|\n *   Blob|ArrayBuffer|DataView|TypedArray>} ...options - request options, handled in order\n * @return {MetroResponse} - a new metro Response object\n */\nexport function response(...options)\n{\n\tlet responseParams = {}\n\tfor (let option of options) {\n\t\tif (typeof option == 'string') {\n\t\t\tresponseParams.body = option\n\t\t} else if (option instanceof Response) {\n\t\t\tObject.assign(responseParams, getResponseParams(option, responseParams))\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tif (option instanceof FormData\n\t\t\t\t|| option instanceof Blob\n\t\t\t\t|| option instanceof ArrayBuffer\n\t\t\t\t|| option instanceof DataView\n\t\t\t\t|| option instanceof ReadableStream\n\t\t\t\t|| option instanceof URLSearchParams\n\t\t\t\t|| option instanceof String\n\t\t\t\t|| (typeof TypedArray != 'undefined' && option instanceof TypedArray)\n\t\t\t) {\n\t\t\t\tresponseParams.body = option\n\t\t\t} else {\n\t\t\t\tObject.assign(responseParams, getResponseParams(option, responseParams))\n\t\t\t}\n\t\t}\n\t}\n\tlet data = undefined\n\tif (responseParams.body) {\n\t\tdata = responseParams.body\n\t}\n\t// if response status is 'null body status', don't set a body\n\t// that is response.status in [101, 204, 205, 304 ] \n\t// see: https://fetch.spec.whatwg.org/#statuses\n\tif ([101, 204, 205, 304 ].includes(responseParams.status)) {\n\t\tresponseParams.body = null\n\t}\n\tlet r = new Response(responseParams.body, responseParams)\t\n\tObject.freeze(r)\n\treturn new Proxy(r, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn response(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'data':\n\t\t\t\t\t// body is turned into ReadableStream\n\t\t\t\t\t// data is the original body param\n\t\t\t\t\treturn data\n\t\t\t\tbreak\n\t\t\t\tcase 'ok':\n\t\t\t\t\treturn (target.status>=200) && (target.status<400)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (typeof target[prop] == 'function') {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\nfunction appendSearchParams(url, params) {\n\tif (typeof params == 'function') {\n\t\t params(url.searchParams, url)\n\t} else {\n\t\tparams = new URLSearchParams(params)\n\t\tparams.forEach((value,key) => {\n\t\t\turl.searchParams.append(key, value)\n\t\t})\n\t}\n}\n\n/**\n * @typedef {URL} MetroURL\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<URL|URLSearchParams|string|Object|Function>} ...options - url options, handled in order\n * \n * Returns a new metro URL object\n * @param {<URL|URLSearchParams|string|Object|Function>} ...options - url options, handled in order\n * @return {MetroURL} - a new metro URL object\n */\nexport function url(...options)\n{\n\tlet validParams = ['hash','host','hostname','href',\n\t\t\t'password','pathname','port','protocol','username','search','searchParams']\n\tlet u = new URL('https://localhost/')\n\tfor (let option of options) {\n\t\tif (typeof option == 'string' || option instanceof String) {\n\t\t\t// option is a relative or absolute url\n\t\t\tu = new URL(option, u)\n\t\t} else if (option instanceof URL \n\t\t\t|| (typeof Location != 'undefined' \n\t\t\t\t&& option instanceof Location)\n\t\t) {\n\t\t\tu = new URL(option)\n\t\t} else if (option instanceof URLSearchParams) {\n\t\t\tappendSearchParams(u, option)\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tfor (let param in option) {\n\t\t\t\tswitch(param) {\n\t\t\t\t\tcase 'search':\n\t\t\t\t\t\tif (typeof option.search == 'function') {\n\t\t\t\t\t\t\toption.search(u.search, u)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tu.search = new URLSearchParams(option.search)\n\t\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t\tcase 'searchParams':\n\t\t\t\t\t\tappendSearchParams(u, option.searchParams)\n\t\t\t\t\tbreak\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tif (!validParams.includes(param)) {\n\t\t\t\t\t\t\tthrow metroError('metro.url: unknown url parameter '+metroURL+'url/unknown-param-name/', param)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (typeof option[param] == 'function') {\n\t\t\t\t\t\t\toption[param](u[param], u)\n\t\t\t\t\t\t} else if (\n\t\t\t\t\t\t\ttypeof option[param] == 'string' || option[param] instanceof String \n\t\t\t\t\t\t\t|| typeof option[param] == 'number' || option[param] instanceof Number\n\t\t\t\t\t\t\t|| typeof option[param] == 'boolean' || option[param] instanceof Boolean\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\tu[param] = ''+option[param]\n\t\t\t\t\t\t} else if (typeof option[param] == 'object' && option[param].toString) {\n\t\t\t\t\t\t\tu[param] = option[param].toString()\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthrow metroError('metro.url: unsupported value for '+param+' '+metroURL+'url/unsupported-param-value/', options[param])\n\t\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthrow metroError('metro.url: unsupported option value '+metroURL+'url/unsupported-option-value/', option)\n\t\t}\n\t}\n\tObject.freeze(u)\n\treturn new Proxy(u, {\n\t\tget(target, prop, receiver) {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn url(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t\tcase 'filename':\n\t\t\t\t\treturn target.pathname.split('/').pop()\n\t\t\t\tbreak\n\t\t\t\tcase 'folderpath':\n\t\t\t\t\treturn target.pathname.substring(0,target.pathname.lastIndexOf('\\\\')+1)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\n/**\n * @typedef {FormData} MetroFormData\n * @property {Symbol(source)} - returns the target Request of this Proxy\n * @property {Symbol(isProxy)} - returns true\n * @method with - returns a new MetroRequest, with the given options added\n * @param {<FormData|Object>} ...options - url options, handled in order\n * \n * Returns a new metro FormData object\n * @param {<FormData|Object>} ...options - formdata options, handled in order\n * @return {MetroURL} - a new metro FormData object\n */\nexport function formdata(...options)\n{\n\tvar params = new FormData()\n\tfor (let option of options) {\n\t\tif (option instanceof HTMLFormElement) {\n\t\t\toption = new FormData(option)\n\t\t}\n\t\tif (option instanceof FormData) {\n\t\t\tfor (let entry of option.entries()) {\n\t\t\t\tparams.append(entry[0],entry[1])\n\t\t\t}\n\t\t} else if (option && typeof option == 'object') {\n\t\t\tfor (let entry of Object.entries(option)) {\n\t\t\t\tif (Array.isArray(entry[1])) {\n\t\t\t\t\tfor (let value of entry[1]) {\n\t\t\t\t\t\tparams.append(entry[0], value)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tparams.append(entry[0],entry[1])\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthrow new metroError('metro.formdata: unknown option type '+metroURL+'formdata/unknown-option-value/', option)\n\t\t}\n\t}\n\tObject.freeze(params)\n\treturn new Proxy(params, {\n\t\tget: (target,prop,receiver) => {\n\t\t\tswitch(prop) {\n\t\t\t\tcase Symbol.metroProxy:\n\t\t\t\t\treturn true\n\t\t\t\tbreak\n\t\t\t\tcase Symbol.metroSource:\n\t\t\t\t\treturn target\n\t\t\t\tbreak\n\t\t\t\t//TODO: add toString() that can check\n\t\t\t\t//headers param: toString({headers:request.headers})\n\t\t\t\t//for the content-type\n\t\t\t\tcase 'with':\n\t\t\t\t\treturn function(...options) {\n\t\t\t\t\t\treturn formdata(target, ...options)\n\t\t\t\t\t}\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tif (target[prop] instanceof Function) {\n\t\t\t\treturn target[prop].bind(target)\n\t\t\t}\n\t\t\treturn target[prop]\n\t\t}\n\t})\n}\n\nconst metroConsole = {\n\terror: (message, ...details) => {\n\t\tconsole.error('\u24C2\uFE0F  ',message, ...details)\n\t},\n\tinfo: (message, ...details) => {\n\t\tconsole.info('\u24C2\uFE0F  ',message, ...details)\n\t},\n\tgroup: (name) => {\n\t\tconsole.group('\u24C2\uFE0F  '+name)\n\t},\n\tgroupEnd: (name) => {\n\t\tconsole.groupEnd('\u24C2\uFE0F  '+name)\n\t}\n}\n\n\n/**\n * Custom Metro Error function that outputs to the console then throws an error\n */\nexport function metroError(message, ...details) {\n\tmetroConsole.error(message, ...details)\n\treturn new Error(message, ...details)\n}\n\n/**\n * Set of debugging tools to trace the request - response flow\n * Tracer are run on all metro fetch calls\n */\nexport const trace = {\n\t/**\n\t * Adds a named tracer function\n\t * @param {string} name - the name of the tracer\n\t * @param {Function} tracer - the tracer function to call\n\t */\n\tadd(name, tracer) {\n\t\tClient.tracers[name] = tracer\n\t},\n\t/**\n\t * Removes a named tracer function\n\t * @param {string} name\n\t */\n\tdelete(name) {\n\t\tdelete Client.tracers[name]\n\t},\n\t/**\n\t * Removes all tracer functions\n\t */\n\tclear() {\n\t\tClient.tracers = {}\n\t},\n\t/**\n\t * Returns a set of request and response tracer functions that use the\n\t * console.group feature to shows nested request/response pairs, with\n\t * most commonly needed information for debugging\n\t */\n\tgroup() {\n\t\tlet group = 0;\n\t\treturn {\n\t\t\trequest: (req, middleware) => {\n\t\t\t\tgroup++\n\t\t\t\tmetroConsole.group(group)\n\t\t\t\tmetroConsole.info(req?.url, req, middleware)\n\t\t\t},\n\t\t\tresponse: (res, middleware) => {\n\t\t\t\tmetroConsole.info(res?.body ? res.body[Symbol.metroSource]: null, res, middleware)\n\t\t\t\tmetroConsole.groupEnd(group)\n\t\t\t\tgroup--\n\t\t\t}\n\t\t}\n\t}\n}\n", "import * as metro from '../metro.mjs'\n\nexport default function jsonmw(options) {\n\toptions = Object.assign({\n\t\tmimetype: 'application/json',\n\t\treviver: null,\n\t\treplacer: null,\n\t\tspace: ''\n\t}, options)\n\n\treturn async (req, next) => {\n\t\tif (!isJSON(req.headers.get('Accept'))) {\n\t\t\treq = req.with({\n\t\t\t\theaders: {\n\t                'Accept': options.mimetype\n\t            }\n\t        })\n\t\t}\n\t\tif (['POST','PUT','PATCH','QUERY'].includes(req.method)) {\n\t\t\tif (req.data && typeof req.data=='object' && !(req.data instanceof ReadableStream)) {\n\t\t\t\tif (!isJSON(req.headers.get('content-type'))) {\n\t\t\t\t\treq = req.with({\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Content-Type':options.mimetype,\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\treq = req.with({\n\t\t\t\t\tbody: JSON.stringify(req.data, options.replacer, options.space)\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\tlet res = await next(req)\n\t\tif (isJSON(res.headers.get('content-type'))) {\n\t\t\tlet tempRes = res.clone()\n\t\t\tlet body = await tempRes.text()\n\t\t\ttry {\n\t\t\t\tlet json = JSON.parse(body, options.reviver)\n\t\t\t\treturn res.with({\n\t\t\t\t\tbody: json\n\t\t\t\t})\n\t\t\t} catch(e) {\n\t\t\t\t// ignore parse errors\n\t\t\t}\n\t\t} \n\t\treturn res\n\t}\n}\n\nconst jsonRE = /^application\\/([a-zA-Z0-9\\-_]+\\+)?json\\b/\nfunction isJSON(contentType) {\n\treturn jsonRE.exec(contentType)\n}", "import * as metro from '../metro.mjs'\n\nexport default function thrower(options) {\n\n\treturn async (req, next) => {\n\t\tlet res = await next(req)\n\t\tif (!res.ok) {\n\t\t\tif (options && typeof options[res.status] == 'function') {\n\t\t\t\tres = options[res.status].apply(res, req)\n\t\t\t} else {\n\t\t\t\tthrow new Error(res.status+': '+res.statusText, {\n\t\t\t\t\tcause: res\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t\treturn res\n\t}\n\n}", "import * as m from './metro.mjs'\nimport jsonmw from './mw/json.mjs'\nimport thrower from './mw/thrower.mjs'\n\nconst metro = Object.assign({}, m, {\n\tmw: {\n\t\tjsonmw,\n\t\tthrower\n\t}\n})\n\nif (!globalThis.metro) {\n\tglobalThis.metro = metro\n}\n\nexport default metro", "import * as metro from '@muze-nl/metro/src/metro.mjs'\nimport { assert, Required, validURL } from '@muze-nl/assert'\nimport {tokenStore} from './tokenstore.mjs'\n\n/**\n * FIXME: refresh_token fails - token not passed correctly\n * \n * oauth2mw returns a middleware for @muze-nl/metro that\n * implements oauth2 authentication in the metro client.\n * it supports the authorization_code, refresh_token and\n * client_credentials grant_type.\n * Since implicit flow is deemed insecure, it is not supported\n * This library follows the OAuth2.1 RFC - https://datatracker.ietf.org/doc/html/draft-ietf-oauth-v2-1-11)\n * Referenced as Oauth2.1 RFC from here on\n * by default it will use PKCE and generate a random code_verifier,\n * to skip this, set options.oauth2_configuration.code_verifier to false\n */\nexport default function oauth2mw(options)\n{\n\tconst defaultOptions = {\n\t\tclient: metro.client(),\n\t\tforce_authorization: false,\n\t\tsite: 'default',\n\t\toauth2_configuration: {\n\t\t\tauthorization_endpoint: '/authorize',\n\t\t\ttoken_endpoint: '/token',\n\t\t\tredirect_uri: globalThis.document?.location.href,\n\t\t\tgrant_type: 'authorization_code',\n\t\t\tcode_verifier: generateCodeVerifier(64)\n\t\t},\n\t\tauthorize_callback: async url => {\n\t\t\tif (window.location.href != url.href) {\n\t\t\t\twindow.location.replace(url.href)\n\t\t\t}\n\t\t\treturn false\n\t\t}\n\t}\n\n\tassert(options, {})\t\n\n\tconst oauth2 = Object.assign({}, defaultOptions.oauth2_configuration, options?.oauth2_configuration)\n\toptions = Object.assign({}, defaultOptions, options)\n\toptions.oauth2_configuration = oauth2\n\n\tconst store = tokenStore(options.site)\n\tif (!options.tokens) {\n\t\toptions.tokens = store.tokens\n\t}\n\tif (!options.state) {\n\t\toptions.state = store.state\n\t}\n\n\tassert(options, {\n\t\toauth2_configuration: {\n\t\t\tclient_id: Required(/.+/),\n\t\t\tgrant_type: 'authorization_code',\n\t\t\tauthorization_endpoint: Required(validURL),\n\t\t\ttoken_endpoint: Required(validURL),\n\t\t\tredirect_uri: Required(validURL)\n\t\t}\n\t})\n\n\tfor (let option in oauth2) {\n\t\tswitch(option) {\n\t\t\tcase 'access_token':\n\t\t\tcase 'authorization_code':\n\t\t\tcase 'refresh_token':\n\t\t\t\toptions.tokens.set(option, oauth2[option])\n\t\t\tbreak\n\t\t}\n\t}\n\n\t/**\n\t * This is the middleware function. It will intercept a request, and if needed\n\t * go through the OAuth2 authorization flow first.\n\t */\n\treturn async function(req, next) {\n\t\tif (options.force_authorization) {\n\t\t\treturn oauth2authorized(req, next)\n\t\t}\n\t\tlet res\n\t\ttry {\n\t\t\tres = await next(req)\n\t\t\tif (res.ok) {\n\t\t\t\treturn res\n\t\t\t}\n\t\t} catch(err) {\n\t\t\tswitch(res.status) { \n\t\t\t\tcase 400: // Oauth2.1 RFC 3.2.4\n\t\t\t\tcase 401: // in case of incorrect authentication method\n\t\t\t\t\t//FIXME: check payload of response as well? yes - may be able to recover\n\t\t\t\t\treturn oauth2authorized(req, next)\n\t\t\t\tbreak\n\t\t\t}\n\t\t\tthrow err\n\t\t}\n\t\tif (!res.ok) {\n\t\t\tswitch(res.status) { \n\t\t\t\tcase 400: // Oauth2.1 RFC 3.2.4\n\t\t\t\tcase 401: // in case of incorrect authentication method\n\t\t\t\t\t//FIXME: check payload of response as well? yes - may be able to recover\n\t\t\t\t\treturn oauth2authorized(req, next)\n\t\t\t\tbreak\n\t\t\t}\n\t\t}\n\t\treturn res\n\t}\n\n\t/**\n\t * Implements the OAuth2 authorization flow for a request\n\t */\n\tasync function oauth2authorized(req, next)\n\t{\n\t\tgetTokensFromLocation()\n\t\tlet accessToken = options.tokens.get('access_token')\n\t\tif (!accessToken) {\n\t\t\ttry {\n\t\t\t\tlet token = await fetchAccessToken()\n\t\t\t\tif (!token) {\n\t\t\t\t\treturn metro.response('false')\n\t\t\t\t}\n\t\t\t} catch(e){\n\t\t\t\t//FIXME: handle some errors here\n\t\t\t\tthrow(e)\n\t\t\t}\n\t\t\treturn oauth2authorized(req, next)\n\t\t} else if (isExpired(accessToken)) {\n\t\t\ttry {\n\t\t\t\tlet token = await fetchRefreshToken()\n\t\t\t\tif (!token) {\n\t\t\t\t\treturn metro.response('false')\n\t\t\t\t}\n\t\t\t} catch(e) {\n\t\t\t\t//FIXME: handle some errors here\n\t\t\t\tthrow(e)\n\t\t\t}\n\t\t\treturn oauth2authorized(req, next)\n\t\t} else {\n\t\t\treq = metro.request(req, {\n\t\t\t\theaders: {\n\t\t\t\t\tAuthorization: accessToken.type+' '+accessToken.value\n\t\t\t\t}\n\t\t\t})\n\t\t\treturn next(req)\n\t\t}\n\t}\n\n\t/**\n\t * Fetches and stores the authorization_code from a redirected URI\n\t * Then removes the authorization_code from the browser URL\n\t * OAuth2 RFC 4.1.2\n\t */\n\tfunction getTokensFromLocation()\n\t{\n\t\tif (typeof window !== 'undefined' && window?.location) {\n\t\t\tlet url = metro.url(window.location)\n\t\t\tlet code, state, params\n\t\t\tif (url.searchParams.has('code')) {\n\t\t\t\tparams = url.searchParams\n\t\t\t\turl = url.with({ search:'' })\n\t\t\t\thistory.pushState({},'',url.href)\n\t\t\t} else if (url.hash) {\n\t\t\t\tlet query = url.hash.substr(1)\n\t\t\t\tparams = new URLSearchParams('?'+query)\n\t\t\t\turl = url.with({ hash:'' })\n\t\t\t\thistory.pushState({},'',url.href)\n\t\t\t}\n\t\t\tif (params) {\n\t\t\t\tcode = params.get('code')\n\t\t\t\tstate = params.get('state')\n\t\t\t\tlet storedState = options.state.get('metro/state')\n\t\t\t\tif (!state || state!==storedState) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tif (code) {\n\t\t\t\t\toptions.tokens.set('authorization_code', code)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Fetches the access_token. If the authorization_code hasn't been retrieved yet,\n\t * it will first try to get that, using the options.callbacks.authorize function.\n\t * If a refresh_token is also returned, it will store that in the options.tokens storage.\n\t */\n\tasync function fetchAccessToken()\n\t{\n\t\tif (oauth2.grant_type === 'authorization_code' && !options.tokens.has('authorization_code')) {\n\t\t\tlet authReqURL = await getAuthorizationCodeURL()\n\t\t\tif (!options.authorize_callback || typeof options.authorize_callback !== 'function') {\n\t\t\t\tthrow metro.metroError('oauth2mw: oauth2 with grant_type:authorization_code requires a callback function in client options.authorize_callback')\n\t\t\t}\n\t\t\tlet token = await options.authorize_callback(authReqURL)\n\t\t\tif (token) {\n\t\t\t\toptions.tokens.set('authorization_code', token)\n\t\t\t} else {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\tlet tokenReq = getAccessTokenRequest()\n\t\tlet response = await options.client.post(tokenReq) //OAuth2.1 RFC 3.2\n\t\tif (!response.ok) {\n\t\t\tlet msg = await response.text()\n\t\t\tthrow metro.metroError('OAuth2mw: fetch access_token: '+response.status+': '+response.statusText, {cause: tokenReq} )\n\t\t}\n\t\tlet data = await response.json()\n\t\t// OAuth2.1 RFC 3.2.3\n\t\toptions.tokens.set('access_token', {\n\t\t\tvalue: data.access_token,\n\t\t\texpires: getExpires(data.expires_in),\n\t\t\ttype: data.token_type,\n\t\t\tscope: data.scope\n\t\t})\n\t\tif (data.refresh_token) {\n\t\t\tlet token = {\n\t\t\t\tvalue: data.refresh_token\n\t\t\t}\n\t\t\toptions.tokens.set('refresh_token', token)\n\t\t}\n\t\treturn data\n\t}\n\n\t/**\n\t * Fetches a new access_token using a stored refresh_token\n\t * If a new refresh_token is also returned, it will update the stored refresh_token\n\t * OAuth2.1 RFC 4.3\n\t */\n\tasync function fetchRefreshToken()\n\t{\n\t\tlet refreshTokenReq = getAccessTokenRequest('refresh_token')\n\t\tlet response = await options.client.post(refreshTokenReq)\n\t\tif (!response.ok) {\n\t\t\tthrow metro.metroError('OAuth2mw: refresh access_token: '+response.status+': '+response.statusText, {cause: refreshTokenReq} )\n\t\t}\n\t\tlet data = await response.json()\n\t\toptions.tokens.set('access_token', {\n\t\t\tvalue:   data.access_token,\n\t\t\texpires: getExpires(data.expires_in),\n\t\t\ttype:    data.token_type,\n\t\t\tscope:   data.scope\n\t\t})\n\t\tif (data.refresh_token) {\n\t\t\tlet token = {\n\t\t\t\tvalue: data.refresh_token\n\t\t\t}\n\t\t\toptions.tokens.set('refresh_token', token)\n\t\t} else {\n\t\t\treturn false\n\t\t}\n\t\treturn data\n\t}\n\n\t/**\n\t * Returns the URL to use to get a authorization_code\n\t */\n\tasync function getAuthorizationCodeURL()\n\t{\n\t\tif (!oauth2.authorization_endpoint) {\n\t\t\tthrow metro.metroError('oauth2mw: Missing options.oauth2_configuration.authorization_endpoint')\n\t\t}\n\t\tlet url = metro.url(oauth2.authorization_endpoint, {hash: ''}) // OAuth2.1 RFC 3.1\n\t\tassert(oauth2, {\n\t\t\tclient_id: /.+/,\n\t\t\tredirect_uri: /.+/,\n\t\t\tscope: /.*/\n\t\t})\n\t\tlet search = {\n\t\t\tresponse_type: 'code', // implicit flow uses 'token' here, but is not considered safe, so not supported\n\t\t\tclient_id:     oauth2.client_id,\n\t\t\tredirect_uri:  oauth2.redirect_uri,\n\t\t\tstate:         oauth2.state || createState(40) // OAuth2.1 RFC says optional, but its a good idea to always add/check it\n\t\t}\n\t\tif (oauth2.response_type) {\n\t\t\tsearch.response_type = oauth2.response_type\n\t\t}\n\t\tif (oauth2.response_mode) {\n\t\t\tsearch.response_mode = oauth2.response_mode\n\t\t}\n\t\toptions.state.set(search.state)\n\t\tif (oauth2.code_verifier) { //PKCE\n\t\t\toptions.tokens.set('code_verifier', oauth2.code_verifier)\n\t\t\tsearch.code_challenge = await generateCodeChallenge(oauth2.code_verifier)\n\t\t\tsearch.code_challenge_method = 'S256'\n\t\t}\n\t\tif (oauth2.client_secret) {\n\t\t\tsearch.client_secret = oauth2.client_secret\n\t\t}\n\n\t\tif (oauth2.scope) {\n\t\t\tsearch.scope = oauth2.scope\n\t\t}\n\t\tif (oauth2.prompt) {\n\t\t\tsearch.prompt = oauth2.prompt\n\t\t}\n\t\treturn metro.url(url, { search })\n\t}\n\n\n\t/**\n\t * Returns a token endpoint request with all the correct parameters, given the\n\t * grant_type. This can then be used in a metro.post.\n\t */\n\tfunction getAccessTokenRequest(grant_type=null)\n\t{\n\t\tassert(oauth2, {\n\t\t\tclient_id: /.+/,\n\t\t\tredirect_uri: /.+/\n\t\t})\n\t\tif (!oauth2.token_endpoint) {\n\t\t\tthrow metro.metroError('oauth2mw: Missing options.endpoints.token url')\n\t\t}\n\t\tlet url = metro.url(oauth2.token_endpoint, {hash: ''}) // OAuth2.1 RFC 3.2\n\t\tlet params = {\n\t\t\tgrant_type: grant_type || oauth2.grant_type,\n\t\t\tclient_id:  oauth2.client_id\n\t\t}\n\t\tconst code_verifier = options.tokens.get('code_verifier') //PKCE\n\t\tif (code_verifier) {\n\t\t\tparams.code_verifier = code_verifier\n\t\t}\n\t\tif (oauth2.client_secret) {\n\t\t\tparams.client_secret = oauth2.client_secret\n\t\t}\n\t\tif (oauth2.scope) {\n\t\t\tparams.scope = oauth2.scope\n\t\t}\n\t\tswitch(oauth2.grant_type) {\n\t\t\tcase 'authorization_code':\n\t\t\t\tparams.redirect_uri = oauth2.redirect_uri\n\t\t\t\tparams.code = options.tokens.get('authorization_code')\n\t\t\tbreak\n\t\t\tcase 'client_credentials':\n\t\t\t\t// nothing to add\n\t\t\tbreak\n\t\t\tcase 'refresh_token':\n\t\t\t\tparams.refresh_token = oauth2.refresh_token\n\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\tthrow new Error('Unknown grant_type: '.oauth2.grant_type)\n\t\t\tbreak\n\t\t}\n\t\treturn metro.request(url, {method: 'POST', body: new URLSearchParams(params) })\n\t}\n\n}\n\n/**\n * Returns true if the access token is expired. False otherwise.\n */\nexport function isExpired(token)\n{\n\tif (!token) {\n\t\treturn true\n\t}\n\tlet expires = new Date(token.expires)\n\tlet now = new Date();\n\treturn now.getTime() > expires.getTime();\n}\n\n/**\n * Returns a new Date based on a duration, which can either be a date\n * or a number of seconds from now.\n */\nexport function getExpires(duration)\n{\n\tif (duration instanceof Date) {\n\t\treturn new Date(duration.getTime()); // return a copy\n\t}\n\tif (typeof duration === 'number') {\n\t\tlet date = new Date();\n\t\tdate.setSeconds(date.getSeconds() + duration);\n\t\treturn date;\n\t}\n\tthrow new TypeError('Unknown expires type '+duration);\n}\n\n/**\n * returns a PKCE code_verifier, as a uint8array\n * pass it to base64url_encode() to get a string\n * https://datatracker.ietf.org/doc/html/rfc7636#section-4\n */\nexport function\tgenerateCodeVerifier(size=64)\n{\n\tsize = Math.min(43, Math.max(128, size))\n\tconst allowed = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n\t\t+ '-._~'\n\tconst random = new Uint8Array(size)\n\tglobalThis.crypto.getRandomValues(random)\n\tconst code_verifier = Array.from(random).map(b => {\n\t\tlet c = allowed[b%allowed.length]\n\t\treturn c\n\t}).join('')\n\treturn code_verifier\n}\n\n/**\n * Returns a PKCE code_challenge derived from a code_verifier\n * Note that this is an async function, so you can't just call\n * it in the defaultOptions part of oauth2mw, or it will become async as well\n * and that is not supported using metro.client().with() (yet)\n */\nexport async function generateCodeChallenge(code_verifier)\n{\n\tconst encoder = new TextEncoder()\n\tconst data = encoder.encode(code_verifier)\n\tconst challenge = await globalThis.crypto.subtle.digest('SHA-256', data)\n\treturn base64url_encode(challenge)\n}\n\n/**\n * Base64url encoding, which handles UTF-8 input strings correctly.\n */\nexport function base64url_encode(buffer)\n{\n\tconst byteString = Array.from(new Uint8Array(buffer), b => String.fromCharCode(b)).join('')\n    return btoa(byteString)\n        .replace(/\\+/g, '-')\n        .replace(/\\//g, '_')\n        .replace(/=+$/, '');\n}\n\n/**\n * Creates a random state to use in the authorization code URL\n */\nexport function createState(length)\n{\n\tconst validChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'\n\tlet randomState = ''\n\tlet counter = 0\n    while (counter < length) {\n        randomState += validChars.charAt(Math.floor(Math.random() * validChars.length))\n        counter++\n    }\n\treturn randomState\n}\n\n/**\n * Returns true if a parameter 'code' is in the document.location searchParams or\n * in the hash, if parsed as searchParams\n */\nexport function isRedirected() {\n\tlet url = new URL(document.location.href)\n\tif (!url.searchParams.has('code')) {\n\t\tif (url.hash) {\n\t\t\tlet query = url.hash.substr(1)\n\t\t\tparams = new URLSearchParams('?'+query)\n\t\t\tif (params.has('code')) {\n\t\t\t\treturn true\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n\treturn true\n}\n\n/**\n * Returns true if there is a valid accessToken or refreshToken in the\n * tokens store.\n * @param (tokensStore.tokens|issuer) tokens - if tokens is a string, it \n * \tis assumed to be the oidc issuer, and tokens are fetched using the default\n *  tokenStore. If you use a different tokenStore, pass the tokens section of it here\n */\nexport function isAuthorized(tokens) {\n\tif (typeof tokens == 'string') {//issuer\n\t\ttokens = tokenStore(tokens).tokens\n\t}\n\tlet accessToken = tokens.get('access_token')\n\tif (accessToken && !isExpired(accessToken)) {\n\t\treturn true\n\t}\n\tlet refreshToken = tokens.get('refresh_token')\n\tif (refreshToken) { // assumes refresh token is still valid\n\t\treturn true\n\t}\n\treturn false\n}", "/*\nTODO: add assertExplain global flag, so that if assert() fails, you can call explain() with\n  the same pattern and it will return text explanation of why it failed, each assertion function must \n  then check assertExplain, and return a text explanation of what fails or succeeds\n  top level can then filter to show only the failures\n  (so that not(x) can show the succeeds message of x)\n*/\n\n/**\n * assertEnabled (Boolean) used to toggle whether the assert()\n * method should test assertions or not.\n */\nglobalThis.assertEnabled = false\n\n/**\n * Enables assertion testing with assert()\n */\nexport function enable() {\n\tglobalThis.assertEnabled = true\n}\n\n/**\n * Disables assertion testing with assert()\n */\nexport function disable() {\n\tglobalThis.assertEnabled = false\n}\n\n/**\n * This function will check the source for the assertions in test, if\n * assertion checking is enabled globally.\n * If it is, and any assertion fails, it will throw an assertError\n * with a list of problems and other details.\n */\nexport function assert(source, test) {\n\tif (globalThis.assertEnabled) {\n\t\tlet problems = fails(source,test)\n\t\tif (problems) {\n\t\t\tconsole.error('\uD83C\uDD70\uFE0F  Assertions failed because of:', problems, 'in this source:', source)\n\t\t\tthrow new Error('Assertions failed', {\n\t\t\t\tcause: { problems, source } \n\t\t\t})\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n */\nexport function Optional(pattern) {\n\treturn function _Optional(data, root, path) {\n\t\tif (typeof data != 'undefined' && data!=null && typeof pattern != 'undefined' ) {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, always.\n */\nexport function Required(pattern) {\n\treturn function _Required(data, root, path) {\n\t\tif (data==null || typeof data == 'undefined') {\n\t\t\treturn error('data is required', data, pattern || 'any value', path)\n\t\t} else if (typeof pattern != 'undefined') {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t} else {\n\t\t\treturn false\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a pattern, only if the value is not null or undefined\n * If null or undefined, it does print a warning to the console.\n */\nexport function Recommended(pattern) {\n\treturn function _Recommended(data, root, path) {\n\t\tif (data==null || typeof data == 'undefined') {\n\t\t\tconsole.warn('data does not contain recommended value', data, pattern, path)\n\t\t\treturn false\n\t\t} else {\n\t\t\treturn fails(data, pattern, root, path)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value against a set of patterns, untill one succeeds\n * Returns an error if none succeed\n */\nexport function oneOf(...patterns) { \n\treturn function _oneOf(data, root, path) {\n\t\tfor(let pattern of patterns) {\n\t\t\tif (!fails(data, pattern, root, path)) {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t\treturn error('data does not match oneOf patterns', data, patterns, path)\n\t}\n}\n\n/**\n * Tests a given array of values against a set of patterns\n * If any value does not match one of the patterns, it will return an error\n * If not given an array to test, it will return an error\n */\nexport function anyOf(...patterns) {\n\treturn function _anyOf(data, root, path) {\n\t\tif (!Array.isArray(data)) {\n\t\t\treturn error('data is not an array',data,'anyOf',path)\n\t\t}\n\t\tfor (let value of data) {\n\t\t\tif (oneOf(...patterns)(value)) {\n\t\t\t\treturn error('data does not match anyOf patterns',value,patterns,path)\n\t\t\t}\n\t\t}\n\t\treturn false\n\t}\n}\n\nexport function allOf(...patterns) {\n\treturn function _allOf(data, root, path) {\n\t\tlet problems = []\n\t\tfor (let pattern of patterns) {\n\t\t\tproblems = problems.concat(fails(data, pattern, root, path))\n\t\t}\n\t\tproblems = problems.filter(Boolean)\n\t\tif (problems.length) {\n\t\t\treturn error('data does not match all given patterns', data, patterns, path, problems)\n\t\t}\n\t}\n}\n\n/**\n * Tests a given value to see if it is a valid (and absolute) URL, by\n * parsing it with the URL() constructor, and then testing the href\n * value to be equal to the initial value.\n */\nexport function validURL(data, root, path) {\n\ttry {\n\t\tif (data instanceof URL) {\n\t\t\tdata = data.href\n\t\t}\n\t\tlet url = new URL(data)\n\t\tif (url.href!=data) {\n\t\t\tif (!(url.href+'/'==data || url.href==data+'/')) {\n\t\t\t\t// new URL() always adds a / as path\n\t\t\t\treturn error('data is not a valid url',data,'validURL',path)\n\t\t\t}\n\t\t}\n\t} catch(e) {\n\t\treturn error('data is not a valid url',data,'validURL',path)\n\t}\n}\n\n/**\n * Tests a given value to see if it looks like a valid email address, by\n * testing it against a regular expression. So there are no guarantees that\n * it is an actual working email address, just that it looks like one.\n */\nexport function validEmail(data, root, path) {\n\tif (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(data)) {\n\t\treturn error('data is not a valid email',data,'validEmail',path)\n\t}\n}\n\n/**\n * Tests a given value to see if it is an object which is an instance of the given\n * constructor\n */\nexport function instanceOf(constructor) {\n\treturn function _instanceOf(data, root, path) {\n\t\tif (!(data instanceof constructor)) {\n\t\t\treturn error('data is not an instanceof pattern',data,constructor,path)\n\t\t}\n\t}\n}\n\n/**\n * Runs the given test pattern on a value, if the test succeeds, it fails\n * the not() test.\n */\nexport function not(pattern) {\n\treturn function _not(data, root, path) {\n\t\tif (!fails(data, pattern, root, path)) {\n\t\t\treturn error('data matches pattern, when required not to', data, pattern, path)\n\t\t}\n\t}\n}\n\n/**\n * returns an array of problems if the data fails to satisfy \n * the assertions in the given pattern, false otherwise\n * @param {any} data    The data to match\n * @param {any} pattern The pattern to match\n * @param {any} root    Root object for assertions, set to data by default\n * @return {Array|false} Array with problems if the pattern fails, false otherwise\n */\nexport function fails(data, pattern, root, path='') {\n\tif (!root) {\n\t\troot = data\n\t}\n\tlet problems = []\n\tif (pattern === Boolean) {\n\t\tif (typeof data != 'boolean' && !(data instanceof Boolean)) {\n\t\t\tproblems.push(error('data is not a boolean', data, pattern, path))\n\t\t}\t\t\n\t} else if (pattern === Number) {\n\t\tif (typeof data != 'number' && !(data instanceof Number)) {\n\t\t\tproblems.push(error('data is not a number', data, pattern, path))\n\t\t}\n\t} else if (pattern === String) {\n\t\tif (typeof data != 'string' && !(data instanceof String)) {\n\t\t\tproblems.push(error('data is not a string', data, pattern, path))\n\t\t}\n\t\tif (data == \"\") {\n\t\t\tproblems.push(error('data is an empty string, which is not allowed', data, pattern, path))\n\t\t}\n\t} else if (pattern instanceof RegExp) {\n    \tif (Array.isArray(data)) {\n\t\t\tlet index = data.findIndex((element,index) => fails(element,pattern,root,path+'['+index+']'))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern, path+'['+index+']'))\n            }\n        } else if (typeof data == 'undefined') {\n        \tproblems.push(error('data is undefined, should match pattern', data, pattern, path))\n    \t} else if (!pattern.test(data)) {\n        \tproblems.push(error('data does not match pattern', data, pattern, path))\n        }\n    } else if (pattern instanceof Function) {\n        let problem = pattern(data, root, path)\n        if (problem) {\n        \tif (Array.isArray(problem)) {\n        \t\tproblems = problems.concat(problem)\n        \t} else {\n\t        \tproblems.push(problem)\n\t        }\n        }\n    } else if (Array.isArray(pattern)) {\n\t\tif (!Array.isArray(data)) {\n\t\t\tproblems.push(error('data is not an array',data,[],path))\n\t\t}\n\t\tfor (let p of pattern) {\n\t\t\tfor (let index of data.keys()) {\n\t\t\t\tlet problem = fails(data[index], p, root, path+'['+index+']')\n\t\t\t\tif (Array.isArray(problem)) {\n\t\t\t\t\tproblems = problems.concat(problem)\n\t\t\t\t} else if (problem) {\n\t\t\t\t\tproblems.push(problem)\n\t\t\t\t}\n\t\t\t}\n    \t}\n    } else if (pattern && typeof pattern == 'object') {\n        if (Array.isArray(data)) {\n            let index = data.findIndex((element,index) => fails(element,pattern,root,path+'['+index+']'))\n            if (index>-1) {\n            \tproblems.push(error('data['+index+'] does not match pattern', data[index], pattern, path+'['+index+']'))\n            }\n        } else if (!data || typeof data != 'object') {\n        \tproblems.push(error('data is not an object, pattern is', data, pattern, path))\n        } else {\n        \tif (data instanceof URLSearchParams) {\n        \t\tdata = Object.fromEntries(data)\n        \t}\n        \tif (pattern instanceof Function) {\n        \t\tlet result = fails(data, pattern, root, path)\n\t            if (result) {\n\t            \tproblems = problems.concat(result)\n\t            }\n        \t} else {\n\t\t        for (const [wKey, wVal] of Object.entries(pattern)) {\n\t\t            let result = fails(data[wKey], wVal, root, path+'.'+wKey)\n\t\t            if (result) {\n\t\t            \tproblems = problems.concat(result)\n\t\t            }\n\t\t        }\n\t\t    }\n\t    }\n    } else {\n    \tif (pattern!=data) {\n    \t\tproblems.push(error('data and pattern are not equal', data, pattern, path))\n    \t}\n    }\n    if (problems.length) {\n    \treturn problems\n    }\n    return false\n}\n\n/**\n * Returns an object with message, found and expected properties\n */ \nexport function error(message, found, expected, path, problems) {\n\tlet result = {\n\t\tmessage,\n\t\tfound,\n\t\texpected,\n\t\tpath\n\t}\n\tif (problems) {\n\t\tresult.problems = problems\n\t}\n\treturn result\n}\n", "export function tokenStore(site) {\n\tlet localState, localTokens\n\tif (typeof localStorage !== 'undefined') {\n\t\tlocalState = {\n\t\t\tget: ()      => localStorage.getItem('metro/state:'+site),\n\t\t\tset: (value) => localStorage.setItem('metro/state:'+site, value),\n\t\t\thas: ()      => localStorage.getItem('metro/state:'+site)!==null\n\t\t}\n\t\tlocalTokens = {\n\t\t\tget: (name)        => JSON.parse(localStorage.getItem(site+':'+name)),\n\t\t\tset: (name, value) => localStorage.setItem(site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => localStorage.getItem(site+':'+name)!==null\n\t\t}\n\t} else {\n\t\tlet stateMap = new Map()\n\t\tlocalState = {\n\t\t\tget: ()      => stateMap.get('metro/state:'+site),\n\t\t\tset: (value) => stateMap.set('metro/state:'+site, value),\n\t\t\thas: ()      => stateMap.has('metro/state:'+site)\n\t\t}\n\t\tlocalTokens = new Map()\n\t}\n\treturn {\n\t\tstate: localState,\n\t\ttokens: localTokens\n\t}\n}", "import metro from '@muze-nl/metro'\nimport * as assert from '@muze-nl/assert'\n\nconst baseResponse = {\n\tstatus: 200,\n\tstatusText: 'OK',\n\theaders: {\n\t\t'Content-Type':'application/json'\n\t}\n}\n\nconst badRequest = (error) => {\n\treturn {\n\t\tstatus: 400,\n\t\tstatusText: 'Bad Request',\n\t\theaders: {\n\t\t\t'Content-Type':'application/json'\n\t\t},\n\t\tbody: JSON.stringify({\n\t\t\terror: 'invalid_request',\n\t\t\terror_description: error\n\t\t})\n\t}\n}\n\nlet error\nlet pkce = {}\n\nexport default function oauth2mockserver(options={}) {\n\n\t// TODO: add DPoP support\n\tconst defaultOptions = {\n\t\t'PKCE': false,\n\t\t'DPoP': false\n\t}\n\toptions = Object.assign({}, defaultOptions, options)\n\n\treturn async (req, next) => {\n\t\tlet url = metro.url(req.url)\n\t\tswitch(url.pathname) {\n\t\t\tcase '/authorize/':\n\t\t\t\tif (error = assert.fails(url.searchParams, {\n\t\t\t\t\tresponse_type: 'code',\n\t\t\t\t\tclient_id: 'mockClientId',\n\t\t\t\t\tstate: assert.Optional(/.*/)\n\t\t\t\t})) {\n\t\t\t\t\treturn metro.response(badRequest(error))\n\t\t\t\t}\n\t\t\t\tif (url.searchParams.has('code_challenge')) {\n\t\t\t\t\tif (!url.searchParams.has('code_challenge_method')) {\n\t\t\t\t\t\treturn metro.response(badRequest('missing code_challenge_method'))\n\t\t\t\t\t}\n\t\t\t\t\tpkce.code_challenge = url.searchParams.get('code_challenge')\n\t\t\t\t\tpkce.code_challenge_method = url.searchParams.get('code_challenge_method')\n\t\t\t\t}\n\t\t\t\treturn metro.response(baseResponse, {\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tcode: 'mockAuthorizeToken',\n\t\t\t\t\t\tstate: url.searchParams.get('state')\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\tbreak\n\t\t\tcase '/token/':\n\t\t\t\tif (req.data instanceof URLSearchParams) {\n\t\t\t\t\tlet body = {}\n\t\t\t\t\treq.data.forEach((value,key) => body[key] = value)\n\t\t\t\t\treq = req.with({body})\n\t\t\t\t}\n\t\t\t\tif (error = assert.fails(req, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tgrant_type: assert.oneOf('refresh_token','authorization_code')\n\t\t\t\t\t}\n\t\t\t\t})) {\n\t\t\t\t\treturn metro.response(badRequest(error))\n\t\t\t\t}\n\t\t\t\tswitch(req.data.grant_type) {\n\t\t\t\t\tcase 'refresh_token':\n\t\t\t\t\t\tif (error = assert.fails(req.data, assert.oneOf({\n\t\t\t\t\t\t\trefresh_token: 'mockRefreshToken',\n\t\t\t\t\t\t\tclient_id: 'mockClientId',\n\t\t\t\t\t\t\tclient_secret: 'mockClientSecret'\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\trefresh_token: 'mockRefreshToken',\n\t\t\t\t\t\t\tclient_id: 'mockClientId',\n\t\t\t\t\t\t\tcode_verifier: /.+/\n\t\t\t\t\t\t}))) {\n\t\t\t\t\t\t\treturn metro.response(badRequest(error))\n\t\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t\tcase 'access_token':\n\t\t\t\t\t\tif (error = assert.fails(req.data, assert.oneOf({\n\t\t\t\t\t\t\tclient_id: 'mockClientId',\n\t\t\t\t\t\t\tclient_secret: 'mockClientSecret'\n\t\t\t\t\t\t}, {\n\t\t\t\t\t\t\tclient_id: 'mockClientId',\n\t\t\t\t\t\t\tcode_challenge: /.*/, //FIXME: check that this matches code_verifier\n\t\t\t\t\t\t\tcode_challenge_method: 'S256'\n\t\t\t\t\t\t}))) {\n\t\t\t\t\t\t\treturn metro.response(badRequest(error))\n\t\t\t\t\t\t}\n\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t\treturn metro.response(baseResponse, {\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\taccess_token: 'mockAccessToken',\n\t\t\t\t\t\ttoken_type: 'mockExample',\n\t\t\t\t\t\texpires_in: 3600,\n\t\t\t\t\t\trefresh_token: 'mockRefreshToken',\n\t\t\t\t\t\texample_parameter: 'mockExampleValue'\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\tbreak\n\t\t\tcase '/protected/':\n\t\t\t\tlet auth = req.headers.get('Authorization')\n\t\t\t\tlet [type,token] = auth ? auth.split(' ') : []\n\t\t\t\tif (!token || token!=='mockAccessToken') {\n\t\t\t\t\treturn metro.response({\n\t\t\t\t\t\tstatus: 401,\n\t\t\t\t\t\tstatusText: 'Forbidden',\n\t\t\t\t\t\tbody: '401 Forbidden'\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t\treturn metro.response(baseResponse, {\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tresult: 'Success'\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\tbreak\n\t\t\tcase '/public/':\n\t\t\t\treturn metro.response(baseResponse, {\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\tresult: 'Success'\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\tbreak\n\t\t\tdefault:\n\t\t\t\treturn metro.response({\n\t\t\t\t\tstatus: 404,\n\t\t\t\t\tstatusText: 'not found',\n\t\t\t\t\tbody: '404 Not Found '+url\n\t\t\t\t})\n\t\t\tbreak\n\t\t}\n\t}\n}", "import metro from '@muze-nl/metro'\nimport { assert, validURL, Required, Recommended, Optional, anyOf } from '@muze-nl/assert'\n// import mwOauth2DPoP from './oauth2.DPoP.mjs'\n\n/**\n * This module allows for oauth2 discovery and returns an oauth2\n * client with all required middleware and options configured\n * \n * oauth2 discovery: https://datatracker.ietf.org/doc/html/rfc8414\n */\n\n//FIXME: list valid algorithms per usecase, these are for JWK\nconst validAlgorithms = [\n\t'HS256','HS384','HS512','RS256','RS384','RS512','ES256','ES384','ES512'\n]\n//FIXME: other auth methods may be defined by extensions to openid connect discovery\nconst validAuthMethods = [\n\t'client_secret_post', 'client_secret_base','client_secret_jwt','private_key_jwt'\n]\n\nconst oauth_authorization_server_metadata = {\n\tissuer: Required(validURL),\n\tauthorization_endpoint: Required(validURL),\n\ttoken_endpoint: Required(validURL),\n\tjwks_uri: Optional(validURL),\n\tregistration_endpoint: Optional(validURL),\n\tscopes_supported: Recommended([]),\n\tresponse_types_supported: Required(anyOf('code','token')),\n\tresponse_modes_supported: Optional([]),\n\tgrant_types_supported: Optional([]),\n\ttoken_endpoint_auth_methods_supported: Optional([]),\n\ttoken_endpoint_auth_signing_alg_values_supported: Optional([]),\n\tservice_documentation: Optional(validURL),\n\tui_locales_supported: Optional([]),\n\top_policy_uri: Optional(validURL),\n\top_tos_uri: Optional(validURL),\n\trevocation_endpoint: Optional(validURL),\n\trevocation_endpoint_auth_methods_supported: Optional(validAuthMethods),\n\trevocation_endpoint_auth_signing_alg_values_supported: Optional(validAlgorithms),\n\tintrospection_endpoint: Optional(validURL),\n\tintrospection_endpoint_auth_methods_supported: Optional(validAuthMethods),\n\tintrospection_endpoint_auth_signing_alg_values_supported: Optional(validAlgorithms),\n\tcode_challendge_methods_supported: Optional([])\n}\n\nexport default function makeClient(options={}) {\n\tconst defaultOptions = {\n\t\tclient: metro.client()\n\t}\n\toptions = Object.assign({}, defaultOptions, options)\n\tassert(options, {\n\t\tissuer: Required(validURL)\n\t})\n\n\t// start discovery\n\tconst oauth_authorization_server_configuration = fetchWellknownOauthAuthorizationServer(options.issuer)\n\tlet client = options.client.with(options.issuer)\n}\n\nasync function fetchWellknownOauthAuthorizationServer(issuer, client)\n{\n\tlet res = client.get(metro.url(issuer,'.wellknown/oauth_authorization_server'))\n\tif (res.ok) {\n\t\tassert(res.headers.get('Content-Type'), /application\\/json.*/)\n\t\tlet configuration = await res.json()\n\t\tassert(configuration, oauth_authorization_server_metadata)\n\t\treturn configuration\n\t}\n\tthrow metro.metroError('metro.oidcmw: Error while fetching '+issuer+'.wellknown/oauth_authorization_server', res)\n}", "/**\n * Searched window.location.search for code parameter, if not set\n * and window.loction.hash is not empty, it will try to interpret\n * the hash as if it was a query string.\n * if code param is found, will message the opener with the code\n * if not, it will message the opener with an error\n * opener window must have a strict match with the origin of the\n * popup page.\n */\nexport function handleRedirect() {\n\tlet params = new URLSearchParams(window.location.search)\n\tif (!params.has('code') && window.location.hash) {\n\t\tlet query = window.location.hash.substr(1)\n\t\tparams = new URLSearchParams('?'+query)\n\t}\n\tlet parent = window.parent ? window.parent : window.opener\n\tif (params.has('code')) {\n\t\tparent.postMessage({\n\t\t\tauthorization_code: params.get('code')\n\t\t}, window.location.origin)\n\t} else if (params.has('error')) {\n\t\tparent.postMessage({\n\t\t\terror\n\t\t}, window.location.origin)\n\t} else {\n\t\tparent.postMessage({\n\t\t\terror: 'Could not find an authorization_code'\n\t\t}, window.location.origin)\n\t}\n}\n\n/**\n * Opens a new window to the oauth2 authorization endpoint, which allows the user to login\n * Returns a Promise, which resolves with the authorization_code if login was succesful\n * Or rejects with an error if not.\n */\nexport function authorizePopup(authorizationCodeURL) {\n\treturn new Promise((resolve, reject) => {\n\t\taddEventListener('message', (evt) => {\n\t\t\tif (event.data.authorization_code) {\n\t\t\t\tresolve(event.data.authorization_code)\n\t\t\t} else if (event.data.error) {\n\t\t\t\treject(event.data.error)\n\t\t\t} else {\n\t\t\t\treject('Unknown authorization error')\n\t\t\t}\n\t\t}, {once:true})\n\t\twindow.open(authorizationCodeURL)\n\t})\n}", "export default function keysStore() {\n\treturn new Promise((resolve, reject) => {\n\t\tconst request = globalThis.indexedDB.open('metro', 1)\n\n\t\trequest.onupgradeneeded = () => request.result.createObjectStore('keyPairs', { keyPath: 'domain'})\n\n\t\trequest.onerror = (event) => {\n\t\t\treject(event)\n\t\t}\n\n\t\trequest.onsuccess = (event) => {\n\t\t\tconst db = event.target.result\n\t\t\tresolve({\n\t\t\t\tset: function(value, key) {\n\t\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst tx = db.transaction('keyPairs', 'readwrite', {durability: 'strict'})\n\t\t\t\t\t\tconst objectStore = tx.objectStore('keyPairs')\n\t\t\t\t\t\ttx.oncomplete = () => {\n\t\t\t\t\t\t\tresolve()\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttx.onerror = reject\n\t\t\t\t\t\tobjectStore.put(value, key)\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tget: function(key) {\n\t\t\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\t\t\tconst tx = db.transaction('keyPairs', 'readonly')\n\t\t\t\t\t\tconst objectStore = tx.objectStore('keyPairs')\n\t\t\t\t\t\tconst request = objectStore.get(key)\n\t\t\t\t\t\trequest.onsuccess = () => {\n\t\t\t\t\t\t\tresolve(request.result)\n\t\t\t\t\t\t}\n\t\t\t\t\t\trequest.onerror = reject\n\t\t\t\t\t\ttx.onerror = reject\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t\tclear: function() {\n\t\t\t\t\treturn new Promise((resolve,reject) => {\n\t\t\t\t\t\tconst tx = db.transaction('keyPairs', 'readwrite')\n\t\t\t\t\t\tconst objectStore = tx.objectStore('keyPairs')\n\t\t\t\t\t\tconst request = objectStore.clear()\n\t\t\t\t\t\trequest.onsuccess = () => {\n\t\t\t\t\t\t\tresolve()\n\t\t\t\t\t\t}\n\t\t\t\t\t\trequest.onerror = reject\n\t\t\t\t\t\ttx.onerror = reject\t\t\t\t\t\t\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t})\n}", "const encoder = new TextEncoder();\nconst decoder = new TextDecoder();\nfunction buf(input) {\n    if (typeof input === 'string') {\n        return encoder.encode(input);\n    }\n    return decoder.decode(input);\n}\nfunction checkRsaKeyAlgorithm(algorithm) {\n    if (typeof algorithm.modulusLength !== 'number' || algorithm.modulusLength < 2048) {\n        throw new OperationProcessingError(`${algorithm.name} modulusLength must be at least 2048 bits`);\n    }\n}\nfunction subtleAlgorithm(key) {\n    switch (key.algorithm.name) {\n        case 'ECDSA':\n            return { name: key.algorithm.name, hash: 'SHA-256' };\n        case 'RSA-PSS':\n            checkRsaKeyAlgorithm(key.algorithm);\n            return {\n                name: key.algorithm.name,\n                saltLength: 256 >> 3,\n            };\n        case 'RSASSA-PKCS1-v1_5':\n            checkRsaKeyAlgorithm(key.algorithm);\n            return { name: key.algorithm.name };\n        case 'Ed25519':\n            return { name: key.algorithm.name };\n    }\n    throw new UnsupportedOperationError();\n}\nasync function jwt(header, claimsSet, key) {\n    if (key.usages.includes('sign') === false) {\n        throw new TypeError('private CryptoKey instances used for signing assertions must include \"sign\" in their \"usages\"');\n    }\n    const input = `${b64u(buf(JSON.stringify(header)))}.${b64u(buf(JSON.stringify(claimsSet)))}`;\n    const signature = b64u(await crypto.subtle.sign(subtleAlgorithm(key), key, buf(input)));\n    return `${input}.${signature}`;\n}\nconst CHUNK_SIZE = 0x8000;\nfunction encodeBase64Url(input) {\n    if (input instanceof ArrayBuffer) {\n        input = new Uint8Array(input);\n    }\n    const arr = [];\n    for (let i = 0; i < input.byteLength; i += CHUNK_SIZE) {\n        arr.push(String.fromCharCode.apply(null, input.subarray(i, i + CHUNK_SIZE)));\n    }\n    return btoa(arr.join('')).replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n}\nfunction b64u(input) {\n    return encodeBase64Url(input);\n}\nfunction randomBytes() {\n    return b64u(crypto.getRandomValues(new Uint8Array(32)));\n}\nclass UnsupportedOperationError extends Error {\n    constructor(message) {\n        super(message ?? 'operation not supported');\n        this.name = this.constructor.name;\n        Error.captureStackTrace?.(this, this.constructor);\n    }\n}\nclass OperationProcessingError extends Error {\n    constructor(message) {\n        super(message);\n        this.name = this.constructor.name;\n        Error.captureStackTrace?.(this, this.constructor);\n    }\n}\nfunction psAlg(key) {\n    switch (key.algorithm.hash.name) {\n        case 'SHA-256':\n            return 'PS256';\n        default:\n            throw new UnsupportedOperationError('unsupported RsaHashedKeyAlgorithm hash name');\n    }\n}\nfunction rsAlg(key) {\n    switch (key.algorithm.hash.name) {\n        case 'SHA-256':\n            return 'RS256';\n        default:\n            throw new UnsupportedOperationError('unsupported RsaHashedKeyAlgorithm hash name');\n    }\n}\nfunction esAlg(key) {\n    switch (key.algorithm.namedCurve) {\n        case 'P-256':\n            return 'ES256';\n        default:\n            throw new UnsupportedOperationError('unsupported EcKeyAlgorithm namedCurve');\n    }\n}\nfunction determineJWSAlgorithm(key) {\n    switch (key.algorithm.name) {\n        case 'RSA-PSS':\n            return psAlg(key);\n        case 'RSASSA-PKCS1-v1_5':\n            return rsAlg(key);\n        case 'ECDSA':\n            return esAlg(key);\n        case 'Ed25519':\n            return 'EdDSA';\n        default:\n            throw new UnsupportedOperationError('unsupported CryptoKey algorithm name');\n    }\n}\nfunction isCryptoKey(key) {\n    return key instanceof CryptoKey;\n}\nfunction isPrivateKey(key) {\n    return isCryptoKey(key) && key.type === 'private';\n}\nfunction isPublicKey(key) {\n    return isCryptoKey(key) && key.type === 'public';\n}\nfunction epochTime() {\n    return Math.floor(Date.now() / 1000);\n}\nexport default async function DPoP(keypair, htu, htm, nonce, accessToken, additional) {\n    const privateKey = keypair?.privateKey;\n    const publicKey = keypair?.publicKey;\n    if (!isPrivateKey(privateKey)) {\n        throw new TypeError('\"keypair.privateKey\" must be a private CryptoKey');\n    }\n    if (!isPublicKey(publicKey)) {\n        throw new TypeError('\"keypair.publicKey\" must be a public CryptoKey');\n    }\n    if (publicKey.extractable !== true) {\n        throw new TypeError('\"keypair.publicKey.extractable\" must be true');\n    }\n    if (typeof htu !== 'string') {\n        throw new TypeError('\"htu\" must be a string');\n    }\n    if (typeof htm !== 'string') {\n        throw new TypeError('\"htm\" must be a string');\n    }\n    if (nonce !== undefined && typeof nonce !== 'string') {\n        throw new TypeError('\"nonce\" must be a string or undefined');\n    }\n    if (accessToken !== undefined && typeof accessToken !== 'string') {\n        throw new TypeError('\"accessToken\" must be a string or undefined');\n    }\n    if (additional !== undefined &&\n        (typeof additional !== 'object' || additional === null || Array.isArray(additional))) {\n        throw new TypeError('\"additional\" must be an object');\n    }\n    return jwt({\n        alg: determineJWSAlgorithm(privateKey),\n        typ: 'dpop+jwt',\n        jwk: await publicJwk(publicKey),\n    }, {\n        ...additional,\n        iat: epochTime(),\n        jti: randomBytes(),\n        htm,\n        nonce,\n        htu,\n        ath: accessToken ? b64u(await crypto.subtle.digest('SHA-256', buf(accessToken))) : undefined,\n    }, privateKey);\n}\nasync function publicJwk(key) {\n    const { kty, e, n, x, y, crv } = await crypto.subtle.exportKey('jwk', key);\n    return { kty, crv, e, n, x, y };\n}\nexport async function generateKeyPair(alg, options) {\n    let algorithm;\n    if (typeof alg !== 'string' || alg.length === 0) {\n        throw new TypeError('\"alg\" must be a non-empty string');\n    }\n    switch (alg) {\n        case 'PS256':\n            algorithm = {\n                name: 'RSA-PSS',\n                hash: 'SHA-256',\n                modulusLength: options?.modulusLength ?? 2048,\n                publicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n            };\n            break;\n        case 'RS256':\n            algorithm = {\n                name: 'RSASSA-PKCS1-v1_5',\n                hash: 'SHA-256',\n                modulusLength: options?.modulusLength ?? 2048,\n                publicExponent: new Uint8Array([0x01, 0x00, 0x01]),\n            };\n            break;\n        case 'ES256':\n            algorithm = { name: 'ECDSA', namedCurve: 'P-256' };\n            break;\n        case 'EdDSA':\n            algorithm = { name: 'Ed25519' };\n            break;\n        default:\n            throw new UnsupportedOperationError();\n    }\n    return (crypto.subtle.generateKey(algorithm, options?.extractable ?? false, ['sign', 'verify']));\n}\n", "import metro from '@muze-nl/metro'\nimport DPoP, {generateKeyPair} from 'dpop'\nimport { assert, Required, Optional, validURL } from '@muze-nl/assert'\nimport keysStore from './keysstore.mjs'\n\nexport default function dpopmw(options) {\n\n\tassert(options, {\n\t\tsite: Required(validURL),\n\t\tauthorization_endpoint: Required(validURL),\n\t\ttoken_endpoint: Required(validURL),\n\t\tdpop_signing_alg_values_supported: Optional([]) // this property is unfortunately rarely supported\n\t})\n\n\treturn async (req, next) => {\n\t\tconst keys = await keysStore()\n\t\tlet keyInfo = await keys.get(options.site)\n\t\tif (!keyInfo) {\n \t\t\t// FIXME fetch from dpop_signing_alg_values_supported\n \t\t\t// which is unfortunately not available usually\n \t\t\tlet keyPair = await generateKeyPair('ES256') // note: don't make them extractable! That potentially allows hackers to steal the privateKey\n\t\t\tkeyInfo = { domain: options.site, keyPair }\n\t\t\tawait keys.set(keyInfo)\n\t\t}\n\t\tconst url = metro.url(req.url)\n\n\t\tif (req.url.startsWith(options.authorization_endpoint)) {\n\t\t\tlet params = req.body\n\t\t\tif (params instanceof URLSearchParams || params instanceof FormData) {\n\t\t\t\tparams.set('dpop_jkt', keyInfo.keyPair.publicKey)\n\t\t\t} else {\n\t\t\t\tparams.dpop_jkt = keyInfo.keyPair.publicKey\n\t\t\t}\n\n\t\t} else if (req.url.startsWith(options.token_endpoint)) {\n\t\t\tconst dpopHeader = await DPoP(keyInfo.keyPair, req.url, req.method)\n\t\t\treq = req.with({\n\t\t\t\theaders: {\n\t\t\t\t\t'DPoP': dpopHeader\n\t\t\t\t}\n\t\t\t})\n\n\t\t} else if (req.headers.has('Authorization')) { //FIXME: not all requests use the dpop bound access token, so check which key to use, or if to add dpop at all\n\t\t\t// note: don't use options.site here, nonce can differ\n\t\t\tconst nonce       = localStorage.getItem(url.host+':nonce') || undefined // null is not acceptible for DpOp()\n\t\t\tconst accessToken = req.headers.get('Authorization').split(' ')[1]\n\t\t\tconst dpopHeader  = await DPoP(keyInfo.keyPair, req.url, req.method, nonce, accessToken)\n\t\t\treq = req.with({\n\t\t\t\theaders: {\n\t\t\t\t\t'Authorization': 'DPoP '+accessToken,\n\t\t\t\t\t'DPoP': dpopHeader\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\tlet response = await next(req)\n\t\tif (response.headers.get('DPoP-Nonce')) {\n\t\t\t// note: don't use options.site here, nonce can differ\n\t\t\tlocalStorage.setItem(url.host+':nonce', response.headers.get('DPoP-Nonce'))\n\t\t}\n\t\treturn response\n\t}\n\t\n}", "import metro from '@muze-nl/metro'\nimport oauth2mw, * as oauth2module from './oauth2.mjs'\nimport * as oauth2mockserver from './oauth2.mockserver.mjs'\nimport * as oauth2discover from './oauth2.discovery.mjs'\nimport { authorizePopup, handleRedirect } from './oauth2.popup.mjs'\nimport { tokenStore } from './tokenstore.mjs'\nimport keysStore from './keysstore.mjs'\nimport dpopmw from './oauth2.dpop.mjs'\n\nconst oauth2 = Object.assign({}, oauth2module, {\n\toauth2mw,\n\tmockserver: oauth2mockserver,\n\tdiscover: oauth2discover,\n\ttokenstore: tokenStore,\n\tdpopmw,\n\tkeysstore: keysStore,\n\tauthorizePopup,\n\tpopupHandleRedirect: handleRedirect\n})\n\nif (!globalThis.metro.oauth2) {\n\tglobalThis.metro.oauth2 = oauth2\n}\n\nexport default oauth2", "import { error } from '@muze-nl/assert'\n\nexport const MustHave = (...options) => \n\t(value, root) => {\n\t\tif (options.filter(o => root.hasOwnKey(o)).length > 0) {\n\t\t\treturn false\n\t\t}\n\t\treturn error('root data must have all of', root, options)\n\t}\n\nexport const MustInclude = (...options) =>\n\t(value) => {\n\t\tif (Array.isArray(value) && options.filter(o => !value.includes(o)).length == 0) {\n\t\t\treturn false\n\t\t} else {\n\t\t\treturn error('data must be an array which includes',value,options)\n\t\t}\n\t}\n\n//TODO: add link to spec\nexport const validJWK = [\n\t'HS256','HS384','HS512','RS256','RS384','RS512','ES256','ES384','ES512'\n]\n\n//TODO: add link to spec\n// FIXME: enter correct values\nexport const validJWA = [\n\t'HS256','HS384','HS512','RS256','RS384','RS512','ES256','ES384','ES512'\n]\n\n//TODO: add link to spec\nexport const validAuthMethods = [\n\t'client_secret_post', 'client_secret_basic','client_secret_jwt','private_key_jwt'\n]\n", "/**\n * This module adheres to OpenID Connect Discovery 1.0 incorporating errata set 2 - december 15, 2023\n * https://openid.net/specs/openid-connect-discovery-1_0.html\n */\nimport metro from '@muze-nl/metro'\nimport jsonmw from '@muze-nl/metro/src/mw/json.mjs'\nimport throwermw from '@muze-nl/metro/src/mw/thrower.mjs'\nimport { validJWA, MustInclude, validAuthMethods } from './oidc.util.mjs'\nimport { assert, fails, Required, Recommended, Optional, oneOf, anyOf, allOf, validURL, instanceOf, not, error } from '@muze-nl/assert'\n\n/**\n * Given options.issuer will get the .well-known/openid-configuration information\n * parse it, assert if follows the specification and return it as a javascript object\n * @param options.issuer Required: URL with the root of the oidc issuer\n * @param options.client Optional: metro client to use in the request\n * @returns object with openid-configuration\n * @throws Error when a network error occurs while fetching openid-configuration\n * @throws assertError when either the options or the openid-configuration fail assertions (and assertion testing is enabled)\n */\nexport default async function oidcDiscovery(options={}) {\n\tassert(options, {\n\t\tclient: Optional(instanceOf(metro.client().constructor)),\n\t\tissuer: Required(validURL)\n\t})\n\n\tconst defaultOptions = {\n\t\tclient: metro.client().with(throwermw()).with(jsonmw()),\n\t\trequireDynamicRegistration: false\n\t}\n\n\toptions = Object.assign({},defaultOptions,options)\n\n\tconst TestSucceeded = false\n\tfunction MustUseHTTPS(url) {\n\t\treturn TestSucceeded // FIXME todo\n\t}\n\n\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderMetadata\n\t// @TODO: this is a first approximation of the specced requirements, needs to implement\n\t// all MUST/MUST NOT etc. notes in the specification.\n\tconst openid_provider_metadata = {\n\t\tissuer: Required(allOf(options.issuer, MustUseHTTPS)),\n\t\tauthorization_endpoint: Required(validURL),\n\t\ttoken_endpoint: Required(validURL),\n\t\tuserinfo_endpoint: Recommended(validURL), // todo: test for https protocol\n\t\tjwks_uri: Required(validURL),\n\t\tregistration_endpoint: options.requireDynamicRegistration \n\t\t\t? Required(validURL) \n\t\t\t: Recommended(validURL),\n\t\tscopes_supported: Recommended(MustInclude('openid')),\n\t\tresponse_types_supported: options.requireDynamicRegistration\n\t\t\t? Required(MustInclude('code','id_token','id_token token')) \n\t\t\t: Required([]),\n\t\tresponse_modes_supported: Optional([]),\n\t\tgrant_types_supported: options.requireDynamicRegistration\n\t\t\t? Optional(MustInclude('authorization_code')) // implicit is required according to the spec, but not used in web apps\n\t\t\t: Optional([]),\n\t\tacr_values_supported: Optional([]),\n\t\tsubject_types_supported: Required([]),\n\t\tid_token_signing_alg_values_supported: Required(MustInclude('RS256')),\n\t\tid_token_encryption_alg_values_supported: Optional([]),\n\t\tid_token_encryption_enc_values_supported: Optional([]),\n\t\tuserinfo_signing_alg_values_supported: Optional([]),\n\t\tuserinfo_encryption_alg_values_supported: Optional([]),\n\t\tuserinfo_encryption_enc_values_supported: Optional([]),\n\t\trequest_object_signing_alg_values_supported: Optional(MustInclude('RS256')), // not testing for 'none'\n\t\trequest_object_encryption_alg_values_supported: Optional([]),\n\t\trequest_object_encryption_enc_values_supported: Optional([]),\n\t\ttoken_endpoint_auth_methods_supported: Optional(anyOf(...validAuthMethods)),\n\t\ttoken_endpoint_auth_signing_alg_values_supported: Optional(MustInclude('RS256'), not(MustInclude('none'))),\n\t\tdisplay_values_supported: Optional(anyOf('page','popup','touch','wap')),\n\t\tclaim_types_supported: Optional(anyOf('normal','aggregated','distributed')),\n\t\tclaims_supported: Recommended([]),\n\t\tservice_documentation: Optional(validURL),\n\t\tclaims_locales_supported: Optional([]),\n\t\tui_locales_supported: Optional([]),\n\t\tclaims_parameter_supported: Optional(Boolean),\n\t\trequest_parameter_supported: Optional(Boolean),\n\t\trequest_uri_parameter_supported: Optional(Boolean),\n\t\top_policy_uri: Optional(validURL),\n\t\top_tos_uri: Optional(validURL)\t\n\t}\n\n\t// fetch openid configuration from wellknown and return the json\n\tconst configURL = metro.url(options.issuer, '.well-known/openid-configuration')\n\n\tconst response = await options.client.get(\n\t\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationRequest\n\t\t// note: this allows path components in the options.issuer url\n\t\tconfigURL\n\t)\n\tconst openid_config = response.data\n\tassert(openid_config, openid_provider_metadata)\n\n\t// https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfigurationValidation\n\tassert(openid_config.issuer, options.issuer)\n\treturn openid_config\n}", "/**\n * This module adheres to OpenID Connect Dynamic Client Registration 1.0 \n * incorporating errata set 2 - december 15, 2023\n * https://openid.net/specs/openid-connect-registration-1_0.html\n */\nimport metro from '@muze-nl/metro'\nimport jsonmw from '@muze-nl/metro/src/mw/json.mjs'\nimport throwermw from '@muze-nl/metro/src/mw/thrower.mjs'\nimport { validJWA, validAuthMethods, MustHave } from './oidc.util.mjs'\nimport { assert, Required, Optional, oneOf, anyOf, validURL, validEmail, not, instanceOf } from '@muze-nl/assert'\n\nexport default async function register(options)\n{\n\n    // https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata\n\tconst openid_client_metadata = {\n\t\tredirect_uris: Required([validURL]),\n\t\tresponse_types: Optional([]),\n\t\tgrant_types: Optional(anyOf('authorization_code','refresh_token')), //TODO: match response_types with grant_types\n\t\tapplication_type: Optional(oneOf('native','web')),\n\t\tcontacts: Optional([validEmail]),\n\t\tclient_name: Optional(String),\n\t\tlogo_uri: Optional(validURL),\n\t\tclient_uri: Optional(validURL),\n\t\tpolicy_uri: Optional(validURL),\n\t\ttos_uri: Optional(validURL),\n\t\tjwks_uri: Optional(validURL, not(MustHave('jwks'))),\n\t\tjwks: Optional(validURL, not(MustHave('jwks_uri'))),\n\t\tsector_identifier_uri: Optional(validURL),\n\t\tsubject_type: Optional(String),\n\t\tid_token_signed_response_alg: Optional(oneOf(...validJWA)),\n\t\tid_token_encrypted_response_alg: Optional(oneOf(...validJWA)),\n\t\tid_token_encrypted_response_enc: Optional(oneOf(...validJWA), MustHave('id_token_encrypted_response_alg')),\n\t\tuserinfo_signed_response_alg: Optional(oneOf(...validJWA)),\n\t\tuserinfo_encrypted_response_alg: Optional(oneOf(...validJWA)),\n\t\tuserinfo_encrypted_response_enc: Optional(oneOf(...validJWA), MustHave('userinfo_encrypted_response_alg')),\n\t\trequest_object_signing_alg: Optional(oneOf(...validJWA)),\n\t\trequest_object_encryption_alg: Optional(oneOf(...validJWA)),\n\t\trequest_object_encryption_enc: Optional(oneOf(...validJWA)),\n\t\ttoken_endpoint_auth_method: Optional(oneOf(...validAuthMethods)),\n\t\ttoken_endpoint_auth_signing_alg: Optional(oneOf(...validJWA)),\n\t\tdefault_max_age: Optional(Number),\n\t\trequire_auth_time: Optional(Boolean),\n\t\tdefault_acr_values: Optional([String]),\n\t\tinitiate_login_uri: Optional([validURL]),\n\t\trequest_uris: Optional([validURL])\n\t}\n\n\tassert(options, {\n\t\tclient: Optional(instanceOf(metro.client().constructor)),\n\t\tregistration_endpoint: validURL, \n\t\tclient_info: openid_client_metadata\n\t})\n\n\tconst defaultOptions = {\n\t\tclient: metro.client().with(throwermw()).with(jsonmw())\n\t}\n\n\toptions = Object.assign({}, defaultOptions, options)\n\n\n\tlet response = await options.client\n\t\t.post(options.registration_endpoint, {\n\t\t\tbody: options.client_info\n\t\t})\n\tlet info = response.data\n\tif (!info.client_id || !info.client_secret) {\n\t\tthrow metro.metroError('metro.oidc: Error: dynamic registration of client failed, no client_id or client_secret returned', response)\n\t}\n\toptions.client_info = Object.assign(options.client_info, info)\n\treturn options.client_info\n}", "export default function oidcStore(site) {\n\tlet store\n\tif (typeof localStorage !== 'undefined') {\n\t\tstore = {\n\t\t\tget: (name)        => JSON.parse(localStorage.getItem('metro/oidc:'+site+':'+name)),\n\t\t\tset: (name, value) => localStorage.setItem('metro/oidc:'+site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => localStorage.getItem('metro/oidc:'+site+':'+name)!==null\n\t\t}\n\t} else {\n\t\tlet storeMap = new Map()\n\t\tstore = {\n\t\t\tget: (name)        => JSON.parse(storeMap.get('metro/oidc:'+site+':'+name)||null),\n\t\t\tset: (name, value) => storeMap.set('metro/oidc:'+site+':'+name, JSON.stringify(value)),\n\t\t\thas: (name)        => storeMap.has('metro/oidc:'+site+':'+name)\n\t\t}\n\t}\n\treturn store\n}", "import * as metro from '@muze-nl/metro/src/metro.mjs'\nimport oauth2mw, * as oauth2 from '@muze-nl/metro-oauth2/src/oauth2.mjs'\nimport dpopmw from '@muze-nl/metro-oauth2/src/oauth2.dpop.mjs'\nimport { assert, Required, Optional, validURL, instanceOf } from '@muze-nl/assert'\nimport discover from './oidc.discovery.mjs'\nimport register from './oidc.register.mjs'\nimport oidcStore from './oidc.store.mjs'\n\nexport default function oidcmw(options={}) {\n\n\tconst defaultOptions = {\n\t\tclient: metro.client(),\n\t\tforce_authorization: false,\n\t\tuse_dpop: true,\n\t\tauthorize_callback: async url => {\n\t\t\tif (window.location.href != url.href) {\n\t\t\t\twindow.location.replace(url.href)\n\t\t\t}\n\t\t\treturn false\n\t\t}\n\t}\n\n\toptions = Object.assign({}, defaultOptions, options)\n\n\tassert(options, {\n\t\tclient: Required(instanceOf(metro.client().constructor)), // required because it is set in defaultOptions\n\t\tclient_info: Required(),\n\t\tissuer: Required(validURL),\n\t\toauth2: Optional({}),\n\t\topenid_configuration: Optional()\n\t})\n\n\tif (!options.store) {\n\t\toptions.store = oidcStore(options.issuer)\n\t}\n\tif (!options.openid_configuration && options.store.has('openid_configuration')) {\n\t\toptions.openid_configuration = options.store.get('openid_configuration')\n\t}\n\tif (!options.client_info.client_id && options.store.has('client_info')) {\n\t\toptions.client_info = options.store.get('client_info')\n\t}\n\n\treturn async (req, next) => {\n\t\tlet res\n\t\tif (!options.force_authorization) {\n\t\t\ttry {\n\t\t\t\tres = await next(req)\n\t\t\t} catch(err) {\n\t\t\t\tif (res.status!=401 && res.status!=403) {\n\t\t\t\t\tthrow err\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (res.ok || (res.status!=401 && res.status!=403)) {\n\t\t\t\treturn res\n\t\t\t}\n\t\t}\n\t\tif (!options.openid_configuration) {\n\t\t\toptions.openid_configuration = await discover({\n\t\t\t\tissuer: options.issuer\n\t\t\t})\n\t\t\toptions.store.set('openid_configuration', options.openid_configuration)\n\t\t}\n\n\t\tif (!options.client_info?.client_id) {\n\t\t\tassert(options.client_info?.client_name, Required())\n\t\t\tif (!options.openid_configuration.registration_endpoint) {\n\t\t\t\tthrow metro.metroError('metro.oidcmw: Error: issuer '+options.issuer+' does not support dynamic client registration, but you haven\\'t specified a client_id')\n\t\t\t}\n\t\t\toptions.client_info = await register({\n\t\t\t\tregistration_endpoint: options.openid_configuration.registration_endpoint,\n\t\t\t\tclient_info: options.client_info\n\t\t\t})\n\t\t\toptions.store.set('client_info', options.client_info)\n\t\t}\n\n\t\t// now initialize an oauth2 client stack, using options.client as default\n\t\t// with forceAuthentication: true\n\t\tconst scope = options.scope || 'openid'\n\n\t\tconst oauth2Options = Object.assign(\n\t\t\t{\n\t\t\t\tsite: options.issuer,\n\t\t\t\tclient: options.client,\n\t\t\t\tforce_authorization: true,\n\t\t\t\tauthorize_callback: options.authorize_callback,\n\t\t\t\toauth2_configuration: {\n\t\t\t\t\tclient_id: options.client_info.client_id,\n\t\t\t\t\tclient_secret: options.client_info.client_secret,\n\t\t\t\t\tgrant_type: 'authorization_code',\n\t\t\t\t\tresponse_type: 'code',\n\t\t\t\t\tresponse_mode: 'query',\n\t\t\t\t\tauthorization_endpoint: options.openid_configuration.authorization_endpoint,\n\t\t\t\t\ttoken_endpoint: options.openid_configuration.token_endpoint,\n\t\t\t\t\tscope, //FIXME: should only use scopes supported by server\n\t\t\t\t\tredirect_uri: options.client_info.redirect_uris[0]\n\t\t\t\t}\n\t\t\t}\n\t\t\t//...\n\t\t)\n\t\t\n\t\tconst storeIdToken = async (req, next) => {\n\t\t\tconst res = await next(req)\n\t\t\tconst contentType = res.headers.get('content-type')\n\t\t\tif (contentType?.startsWith('application/json')) {\n\t\t\t\t//FIXME: check that this is actually the token endpoint\n\t\t\t\tlet id_token = res.data?.id_token\n\t\t\t\tif (!id_token) {\n\t\t\t\t\tconst res2 = res.clone() // otherwise res.body can't be read again\n\t\t\t\t\ttry {\n\t\t\t\t\t\tlet data = await res2.json()\n\t\t\t\t\t\tif (data && data.id_token) {\n\t\t\t\t\t\t\tid_token = data.id_token\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch(e) {\n\t\t\t\t\t\t// ignore errors\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (id_token) {\n\t\t\t\t\toptions.store.set('id_token', id_token)\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn res\n\t\t}\n\n\t\tlet oauth2client = options.client.with(options.issuer).with(storeIdToken)\n\n\t\tif (options.use_dpop) {\n\t\t\tconst dpopOptions = {\n\t\t\t\tsite: options.issuer,\n\t\t\t\tauthorization_endpoint: options.openid_configuration.authorization_endpoint,\n\t\t\t\ttoken_endpoint: options.openid_configuration.token_endpoint,\n\t\t\t\tdpop_signing_alg_values_supported: options.openid_configuration.dpop_signing_alg_values_supported\n\t\t\t}\n\t\t\toauth2client = oauth2client.with(dpopmw(dpopOptions)) // add DPoP headers in requests with Authorization headers\n\t\t\toauth2Options.client = oauth2client // make sure oath2 token request use dpop\n\t\t}\n\n\t\toauth2client = oauth2client.with(oauth2mw(oauth2Options))\n\n\t\tres = await oauth2client.fetch(req)\n\n\t\treturn res\n\t}\n\n}\n\nexport function isRedirected() {\n\treturn oauth2.isRedirected()\n}\n\nexport function idToken(options) {\n\tif (!options.store) {\n\t\tif (!options.issuer) {\n\t\t\tthrow metro.metroError('Must supply options.issuer or options.store to get the id_token')\n\t\t}\n\t\toptions.store = oidcStore(options.issuer)\n\t}\n\treturn options.store.get('id_token')\n}\n", "import metro from '@muze-nl/metro'\nimport oauth2 from '@muze-nl/metro-oauth2'\nimport oidcDiscover from './oidc.discovery.mjs'\nimport oidcRegister from './oidc.register.mjs'\nimport oidcmw, {isRedirected, idToken} from './oidcmw.mjs'\n\nconst oidc = {\n\toidcmw,\n\tdiscover: oidcDiscover,\n\tregister: oidcRegister,\n\tisRedirected,\n\tidToken\n}\n\nif (!globalThis.metro.oidc) {\n\tglobalThis.metro.oidc = oidc\n}\n\nexport default oidc", "import * as metro from '@muze-nl/metro'\nimport oidc from '@muze-nl/metro-oidc'\n\nexport class oidcClient extends metroClient\n{\n\n\tconstructor(...options)\n\t{\n\t\tconst defaultOptions = {\n\t\t\toidc: {\n\t\t\t\tclient_info: {\n\t\t\t\t\tclient_id: metro.url(window.location).authority\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\toptions.forEach(o => {\n\t\t\tif (o && typeof o == 'object') {\n\t\t\t\tObject.assign(defaultOptions, o)\n\t\t\t}\n\t\t})\n\t\tthis.oidc = defaultOptions.oidc || {}\n\t\tconst oidcmw = oidc.oidcmw(this.oidc)\n\t\toptions.push({\n\t\t\tmiddleware: {\n\t\t\t\toidcmw\n\t\t\t}\n\t\t})\n\t\tthis.options = defaultOptions\n\t\tsuper.apply(options)\n\t}\n\n\tasync signIn(issuer=null) {\n\t\tlet options = structuredClone(this.options)\n\t\tif (issuer) {\n\t\t\toptions.oidc.issuer = issuer\n\t\t}\n\t\tlet result = oidc.authenticate(options.oidc)\n\t\tif (result) {\n\t\t\treturn new oidcClient(options)\n\t\t} else {\n\t\t\tthrow new Error('signIn failed')\n\t\t}\n\t}\n\n\tisAuthenticated() {\n\t\treturn oidc.idToken(this.options.openid_configuration)\n\t}\n\n\tasync signOut() {\n\t\tif (!this.isAuthenticated()) {\n\t\t\treturn true\n\t\t}\n\t\tif (this.options.oidc.openid_configuration.end_session_endpoint) {\n\t\t\tlet response = await this.get(this.options.oidc.openid_configuration.end_session_endpoint, {\n\t\t\t\tid_token_hint: oidc.idToken(this.options.oidc),\n\t\t\t\tclient_id: this.options.oidc.client_info.client_id,\n\t\t\t\tpost_logout_redirect_url: this.options.oidc.client_info.post_logout_redirect_urls[0]\n\t\t\t})\n\t\t}\n\t\tthis.options.oidc.oauth2_configuration.tokens.clear()\n\t\tthis.options.oidc.openid_configuration.store.clear()\n\t\treturn true\n\t}\n}\n\n"],
  "mappings": "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",
  "names": ["metro_exports", "__export", "client", "formdata", "metroError", "request", "response", "trace", "url", "metroURL", "Client", "_Client", "#options", "#verbs", "options", "option", "#addMiddlewares", "param", "verb", "middlewares", "index", "m", "req", "res", "next", "middleware", "tracers", "tracer", "getRequestParams", "req", "current", "params", "prop", "value", "url", "key", "val", "request", "options", "requestParams", "option", "r", "data", "target", "receiver", "getResponseParams", "res", "response", "responseParams", "appendSearchParams", "validParams", "u", "param", "metroError", "metroURL", "formdata", "entry", "metroConsole", "message", "details", "name", "trace", "tracer", "Client", "group", "middleware", "jsonmw", "options", "req", "next", "isJSON", "res", "body", "json", "jsonRE", "contentType", "thrower", "options", "req", "next", "res", "metro", "metro_exports", "jsonmw", "thrower", "everything_default", "oauth2_exports", "__export", "base64url_encode", "createState", "oauth2mw", "generateCodeChallenge", "generateCodeVerifier", "getExpires", "isAuthorized", "isExpired", "isRedirected", "assert", "source", "test", "problems", "fails", "Optional", "pattern", "data", "root", "path", "Required", "error", "Recommended", "oneOf", "patterns", "anyOf", "value", "allOf", "validURL", "url", "validEmail", "instanceOf", "constructor", "not", "index", "element", "problem", "p", "result", "wKey", "wVal", "message", "found", "expected", "tokenStore", "site", "localState", "localTokens", "value", "name", "stateMap", "oauth2mw", "options", "defaultOptions", "client", "generateCodeVerifier", "url", "assert", "oauth2", "store", "tokenStore", "Required", "validURL", "option", "req", "next", "oauth2authorized", "res", "err", "getTokensFromLocation", "accessToken", "isExpired", "fetchRefreshToken", "response", "e", "request", "fetchAccessToken", "code", "state", "params", "query", "storedState", "authReqURL", "getAuthorizationCodeURL", "metroError", "token", "tokenReq", "getAccessTokenRequest", "msg", "data", "getExpires", "refreshTokenReq", "search", "createState", "generateCodeChallenge", "grant_type", "code_verifier", "expires", "duration", "date", "size", "allowed", "random", "b", "challenge", "base64url_encode", "buffer", "byteString", "length", "validChars", "randomState", "counter", "isRedirected", "isAuthorized", "tokens", "oauth2_mockserver_exports", "__export", "oauth2mockserver", "baseResponse", "badRequest", "error", "pkce", "oauth2mockserver", "options", "req", "next", "url", "everything_default", "fails", "Optional", "body", "value", "key", "oneOf", "auth", "type", "token", "oauth2_discovery_exports", "__export", "makeClient", "validAlgorithms", "validAuthMethods", "oauth_authorization_server_metadata", "Required", "validURL", "Optional", "Recommended", "anyOf", "makeClient", "options", "defaultOptions", "everything_default", "assert", "oauth_authorization_server_configuration", "fetchWellknownOauthAuthorizationServer", "client", "issuer", "res", "configuration", "handleRedirect", "params", "query", "parent", "authorizePopup", "authorizationCodeURL", "resolve", "reject", "evt", "keysStore", "resolve", "reject", "request", "event", "db", "value", "key", "tx", "objectStore", "encoder", "decoder", "buf", "input", "checkRsaKeyAlgorithm", "algorithm", "OperationProcessingError", "subtleAlgorithm", "key", "UnsupportedOperationError", "jwt", "header", "claimsSet", "b64u", "signature", "CHUNK_SIZE", "encodeBase64Url", "arr", "i", "randomBytes", "message", "psAlg", "rsAlg", "esAlg", "determineJWSAlgorithm", "isCryptoKey", "isPrivateKey", "isPublicKey", "epochTime", "DPoP", "keypair", "htu", "htm", "nonce", "accessToken", "additional", "privateKey", "publicKey", "publicJwk", "kty", "e", "n", "x", "y", "crv", "generateKeyPair", "alg", "options", "dpopmw", "options", "assert", "Required", "validURL", "Optional", "req", "next", "keys", "keysStore", "keyInfo", "keyPair", "generateKeyPair", "url", "everything_default", "params", "dpopHeader", "DPoP", "nonce", "accessToken", "response", "oauth2", "oauth2_exports", "oauth2mw", "oauth2_mockserver_exports", "oauth2_discovery_exports", "tokenStore", "dpopmw", "keysStore", "authorizePopup", "handleRedirect", "MustHave", "options", "value", "root", "error", "MustInclude", "o", "validJWA", "validAuthMethods", "oidcDiscovery", "options", "assert", "Optional", "instanceOf", "everything_default", "Required", "validURL", "defaultOptions", "thrower", "jsonmw", "TestSucceeded", "MustUseHTTPS", "url", "openid_provider_metadata", "allOf", "Recommended", "MustInclude", "anyOf", "validAuthMethods", "not", "configURL", "openid_config", "register", "options", "openid_client_metadata", "Required", "validURL", "Optional", "anyOf", "oneOf", "validEmail", "not", "MustHave", "validJWA", "validAuthMethods", "assert", "instanceOf", "everything_default", "defaultOptions", "thrower", "jsonmw", "response", "info", "oidcStore", "site", "store", "name", "value", "storeMap", "oidcmw", "options", "defaultOptions", "client", "url", "assert", "Required", "instanceOf", "validURL", "Optional", "oidcStore", "req", "next", "res", "err", "oidcDiscovery", "metroError", "register", "scope", "oauth2Options", "storeIdToken", "id_token", "res2", "data", "oauth2client", "dpopOptions", "dpopmw", "oauth2mw", "isRedirected", "idToken", "oidc", "oidcmw", "oidcDiscovery", "register", "isRedirected", "idToken", "browser_default", "oidcClient", "_oidcClient", "options", "defaultOptions", "o", "oidcmw", "browser_default", "issuer", "response"]
}
